| routine_name                                | routine_definition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| add_social_connection                       | 
DECLARE
  existing_connection JSONB;
  current_connections JSONB;
BEGIN
  -- Get current connections
  SELECT COALESCE(linked_social_accounts, '[]'::jsonb) INTO current_connections
  FROM users 
  WHERE wallet_address = primary_wallet_address;
  
  -- Check if connection already exists
  IF jsonb_path_exists(current_connections, ('$[*] ? (@.provider == "' || provider_name || '")')::jsonpath) THEN
    RETURN FALSE; -- Connection already exists
  END IF;
  
  -- Add new social connection
  UPDATE users 
  SET 
    linked_social_accounts = current_connections || jsonb_build_array(
      jsonb_build_object(
        'provider', provider_name,
        'provider_id', provider_id,
        'email', provider_email,
        'social_address', social_address,
        'connected_at', now(),
        'is_primary', FALSE
      )
    ),
    connection_history = COALESCE(connection_history, '[]'::jsonb) || jsonb_build_array(
      jsonb_build_object(
        'action', 'social_connected',
        'provider', provider_name,
        'timestamp', now()
      )
    ),
    updated_at = now()
  WHERE wallet_address = primary_wallet_address;
  
  RETURN FOUND;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| add_user_balance                            | 
BEGIN
  -- Update or insert user balance
  INSERT INTO user_balances (
    wallet_address, 
    total_neft_claimed, 
    total_xp_earned, 
    total_nft_count,
    available_neft,
    last_updated
  ) VALUES (
    user_wallet,
    neft_amount,
    xp_amount,
    nft_count,
    neft_amount, -- New NEFT is immediately available
    NOW()
  )
  ON CONFLICT (wallet_address) 
  DO UPDATE SET
    total_neft_claimed = user_balances.total_neft_claimed + neft_amount,
    total_xp_earned = user_balances.total_xp_earned + xp_amount,
    total_nft_count = user_balances.total_nft_count + nft_count,
    available_neft = user_balances.available_neft + neft_amount, -- Add to available balance
    last_updated = NOW();

  RETURN TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RAISE LOG 'Error in add_user_balance: %', SQLERRM;
    RETURN FALSE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| add_wallet_connection                       | 
DECLARE
  current_connections JSONB;
BEGIN
  -- Get current connections
  SELECT COALESCE(linked_wallet_addresses, '[]'::jsonb) INTO current_connections
  FROM users 
  WHERE wallet_address = primary_wallet_address;
  
  -- Check if wallet connection already exists
  IF jsonb_path_exists(current_connections, ('$[*] ? (@.address == "' || new_wallet_address || '")')::jsonpath) THEN
    RETURN FALSE; -- Connection already exists
  END IF;
  
  -- Add new wallet connection
  UPDATE users 
  SET 
    linked_wallet_addresses = current_connections || jsonb_build_array(
      jsonb_build_object(
        'address', new_wallet_address,
        'wallet_type', wallet_type_name,
        'connected_at', now(),
        'is_primary', FALSE
      )
    ),
    connection_history = COALESCE(connection_history, '[]'::jsonb) || jsonb_build_array(
      jsonb_build_object(
        'action', 'wallet_connected',
        'wallet_type', wallet_type_name,
        'address', new_wallet_address,
        'timestamp', now()
      )
    ),
    updated_at = now()
  WHERE wallet_address = primary_wallet_address;
  
  RETURN FOUND;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| aggregate_user_rewards_from_all_sources     | 
DECLARE
  result JSON;
  
  -- Campaign rewards
  campaign_neft DECIMAL(18,8) := 0;
  campaign_xp INTEGER := 0;
  
  -- Daily claims
  daily_neft DECIMAL(18,8) := 0;
  daily_xp INTEGER := 0;
  
  -- Achievement rewards (claimed only)
  achievement_neft DECIMAL(18,8) := 0;
  achievement_xp INTEGER := 0;
  
  -- Staking rewards (claimed only)
  staking_neft DECIMAL(18,8) := 0;
  staking_xp INTEGER := 0;
  
  -- Staked amounts (affects available_neft)
  staked_amount DECIMAL(18,8) := 0;
  
  -- Totals
  total_neft DECIMAL(18,8);
  total_xp INTEGER;
  available_neft DECIMAL(18,8);
BEGIN
  -- Validate input
  IF user_wallet IS NULL OR user_wallet = '' THEN
    RAISE EXCEPTION 'user_wallet parameter cannot be null or empty';
  END IF;

  -- 1. Aggregate from campaign_reward_claims table
  BEGIN
    SELECT 
      COALESCE(SUM(neft_reward), 0),
      COALESCE(SUM(xp_reward), 0)
    INTO campaign_neft, campaign_xp
    FROM campaign_reward_claims 
    WHERE wallet_address = user_wallet;
    
    RAISE LOG 'Campaign rewards for %: NEFT=%, XP=%', user_wallet, campaign_neft, campaign_xp;
  EXCEPTION WHEN OTHERS THEN
    campaign_neft := 0;
    campaign_xp := 0;
    RAISE LOG 'Error getting campaign rewards for %: %', user_wallet, SQLERRM;
  END;

  -- 2. Aggregate from daily_claims table
  BEGIN
    SELECT 
      COALESCE(SUM(total_neft_reward), 0),
      COALESCE(SUM(total_xp_reward), 0)
    INTO daily_neft, daily_xp
    FROM daily_claims 
    WHERE wallet_address = user_wallet;
    
    RAISE LOG 'Daily claims for %: NEFT=%, XP=%', user_wallet, daily_neft, daily_xp;
  EXCEPTION WHEN OTHERS THEN
    daily_neft := 0;
    daily_xp := 0;
    RAISE LOG 'Error getting daily claims for %: %', user_wallet, SQLERRM;
  END;

  -- 3. Aggregate from user_achievements table (claimed achievements only)
  BEGIN
    SELECT 
      COALESCE(SUM(neft_reward), 0),
      COALESCE(SUM(xp_reward), 0)
    INTO achievement_neft, achievement_xp
    FROM user_achievements ua
    JOIN achievements_master am ON ua.achievement_key = am.achievement_key
    WHERE ua.wallet_address = user_wallet 
      AND ua.status = 'completed' 
      AND ua.claimed_at IS NOT NULL;
    
    RAISE LOG 'Achievement rewards for %: NEFT=%, XP=%', user_wallet, achievement_neft, achievement_xp;
  EXCEPTION WHEN OTHERS THEN
    achievement_neft := 0;
    achievement_xp := 0;
    RAISE LOG 'Error getting achievement rewards for %: %', user_wallet, SQLERRM;
  END;

  -- 4. Aggregate from staking_rewards table (claimed rewards only)
  BEGIN
    SELECT 
      COALESCE(SUM(reward_amount), 0),
      0 -- Staking rewards are NEFT only, no XP
    INTO staking_neft, staking_xp
    FROM staking_rewards 
    WHERE wallet_address = user_wallet 
      AND is_claimed = true;
    
    RAISE LOG 'Staking rewards for %: NEFT=%, XP=%', user_wallet, staking_neft, staking_xp;
  EXCEPTION WHEN OTHERS THEN
    staking_neft := 0;
    staking_xp := 0;
    RAISE LOG 'Error getting staking rewards for %: %', user_wallet, SQLERRM;
  END;

  -- 5. Get currently staked amount from staked_tokens table
  BEGIN
    SELECT COALESCE(SUM(amount), 0)
    INTO staked_amount
    FROM staked_tokens 
    WHERE wallet_address = user_wallet;
    
    RAISE LOG 'Staked amount for %: %', user_wallet, staked_amount;
  EXCEPTION WHEN OTHERS THEN
    staked_amount := 0;
    RAISE LOG 'Error getting staked amount for %: %', user_wallet, SQLERRM;
  END;

  -- Calculate totals from all sources
  total_neft := COALESCE(campaign_neft, 0) + COALESCE(daily_neft, 0) + COALESCE(achievement_neft, 0) + COALESCE(staking_neft, 0);
  total_xp := COALESCE(campaign_xp, 0) + COALESCE(daily_xp, 0) + COALESCE(achievement_xp, 0) + COALESCE(staking_xp, 0);
  
  -- Calculate available NEFT (total earned minus staked)
  available_neft := GREATEST(0, total_neft - COALESCE(staked_amount, 0));

  RAISE LOG 'Final totals for %: total_neft=%, total_xp=%, available_neft=%, staked=%', 
    user_wallet, total_neft, total_xp, available_neft, staked_amount;

  -- Build result JSON with detailed breakdown
  SELECT json_build_object(
    'total_neft_claimed', total_neft,
    'total_xp_earned', total_xp,
    'available_neft', available_neft,
    'staked_neft', COALESCE(staked_amount, 0),
    'last_updated', NOW(),
    -- Detailed breakdown by source for debugging
    'breakdown', json_build_object(
      'campaign_neft', campaign_neft,
      'campaign_xp', campaign_xp,
      'daily_neft', daily_neft,
      'daily_xp', daily_xp,
      'achievement_neft', achievement_neft,
      'achievement_xp', achievement_xp,
      'staking_neft', staking_neft,
      'staking_xp', staking_xp,
      'staked_amount', staked_amount
    )
  ) INTO result;

  RETURN result;
EXCEPTION
  WHEN OTHERS THEN
    -- Return error details for debugging
    RAISE LOG 'Error in aggregate_user_rewards_from_all_sources for %: %', user_wallet, SQLERRM;
    SELECT json_build_object(
      'error', 'Aggregation failed: ' || SQLERRM,
      'total_neft_claimed', 0,
      'total_xp_earned', 0,
      'available_neft', 0,
      'staked_neft', 0,
      'last_updated', NOW(),
      'breakdown', json_build_object(
        'campaign_neft', 0, 'campaign_xp', 0,
        'daily_neft', 0, 'daily_xp', 0,
        'achievement_neft', 0, 'achievement_xp', 0,
        'staking_neft', 0, 'staking_xp', 0,
        'staked_amount', 0
      )
    ) INTO result;
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                       |
| authenticate_or_create_user                 | 
DECLARE
  existing_user RECORD;
  user_record RECORD;
  new_user_id UUID;
  timestamp_now TIMESTAMPTZ := now();
  formatted_provider TEXT;
  provider_id TEXT;
BEGIN
  -- Normalize provider name
  formatted_provider := lower(login_provider);
  
  -- Extract provider ID from social address format
  IF login_method = 'social' AND login_address LIKE 'social:%' THEN
    provider_id := split_part(login_address, ':', 3);
  ELSE
    provider_id := 'unknown';
  END IF;
  
  -- Check if this address already exists in any form
  SELECT * INTO existing_user FROM find_user_by_any_address(login_address) LIMIT 1;
  
  IF existing_user.user_id IS NOT NULL THEN
    -- User exists - update last login and return existing user
    UPDATE users 
    SET 
      last_login = timestamp_now,
      updated_at = timestamp_now,
      -- Update profile info if provided
      email = COALESCE(user_email, users.email),
      display_name = COALESCE(user_name, users.display_name),
      avatar_url = COALESCE(user_avatar, users.avatar_url)
    WHERE id = existing_user.user_id;
    
    -- Return existing user info
    RETURN QUERY
    SELECT 
      existing_user.user_id,
      existing_user.wallet_address,
      COALESCE(user_email, existing_user.email) as email,
      COALESCE(user_name, existing_user.display_name) as display_name,
      COALESCE(user_avatar, existing_user.avatar_url) as avatar_url,
      false as is_new_user,
      false as linked_as_additional,
      existing_user.connection_type;
    
    RETURN;
  END IF;
  
  -- No existing user found - create new user
  new_user_id := gen_random_uuid();
  
  -- Determine the appropriate display name
  IF user_name IS NULL OR user_name = '' THEN
    IF login_method = 'social' THEN
      user_name := formatted_provider || ' User';
    ELSE
      user_name := substring(login_address, 1, 6) || '...' || right(login_address, 4);
    END IF;
  END IF;
  
  -- Insert new user
  INSERT INTO users (
    id,
    wallet_address,
    email,
    display_name,
    avatar_url,
    provider,
    social_provider,
    wallet_type,
    metadata,
    created_at,
    updated_at,
    last_login
  ) VALUES (
    new_user_id,
    login_address,
    user_email,
    user_name,
    user_avatar,
    formatted_provider,
    CASE WHEN login_method = 'social' THEN formatted_provider ELSE NULL END,
    CASE WHEN login_method = 'wallet' THEN formatted_provider ELSE NULL END,
    additional_data || jsonb_build_object(
      'login_method', login_method,
      'provider_id', provider_id,
      'created_via', login_method || ':' || formatted_provider
    ),
    timestamp_now,
    timestamp_now,
    timestamp_now
  );
  
  -- Return new user info
  RETURN QUERY
  SELECT 
    new_user_id,
    login_address,
    user_email,
    user_name,
    user_avatar,
    true as is_new_user,
    false as linked_as_additional,
    'primary_' || login_method as connection_type;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| auto_claim_rewards_to_balance               | 
BEGIN
    -- When rewards are marked as claimed, add to user balance
    IF NEW.is_claimed = true AND OLD.is_claimed = false THEN
        -- Add reward to user balance
        INSERT INTO user_balances (wallet_address, total_neft_claimed, available_neft, total_xp_earned, last_updated)
        VALUES (NEW.wallet_address, NEW.reward_amount, NEW.reward_amount, 0, NOW())
        ON CONFLICT (wallet_address) 
        DO UPDATE SET 
            total_neft_claimed = user_balances.total_neft_claimed + NEW.reward_amount,
            available_neft = user_balances.available_neft + NEW.reward_amount,
            last_updated = NOW();
    END IF;
    
    RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| award_burn_chance                           | 
BEGIN
  INSERT INTO user_burn_chances (
    wallet_address, 
    source, 
    task_count_required, 
    tasks_completed
  ) VALUES (
    p_wallet_address, 
    p_source, 
    p_task_count_required, 
    p_tasks_completed
  );
  
  RETURN TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RETURN FALSE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| batch_update_user_balance                   | 
BEGIN
  -- Update user balance with changes
  INSERT INTO user_balances (
    wallet_address, 
    total_neft_claimed, 
    total_xp_earned, 
    last_updated
  )
  VALUES (
    user_wallet, 
    neft_change, 
    xp_change, 
    NOW()
  )
  ON CONFLICT (wallet_address)
  DO UPDATE SET
    total_neft_claimed = GREATEST(0, user_balances.total_neft_claimed + EXCLUDED.total_neft_claimed),
    total_xp_earned = GREATEST(0, user_balances.total_xp_earned + EXCLUDED.total_xp_earned),
    last_updated = NOW();

  RETURN TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RAISE LOG 'Error in batch_update_user_balance: %', SQLERRM;
    RETURN FALSE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| begin_transaction                           | 
BEGIN
    -- Begin transaction (this is implicit in Supabase)
    RAISE NOTICE 'Transaction started';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| calculate_daily_reward                      | 
DECLARE
  milestone_data RECORD;
BEGIN
  -- Check if this is a milestone day
  SELECT * INTO milestone_data 
  FROM daily_claim_milestones 
  WHERE milestone_day = streak_count;
  
  IF milestone_data IS NOT NULL THEN
    -- Milestone reward
    RETURN QUERY SELECT 
      milestone_data.base_neft_reward,
      milestone_data.bonus_neft_reward,
      milestone_data.base_xp_reward,
      milestone_data.bonus_xp_reward,
      milestone_data.nft_reward,
      milestone_data.milestone_name,
      TRUE;
  ELSE
    -- Regular reward based on streak
    RETURN QUERY SELECT 
      (10.0 + (streak_count * 0.5))::DECIMAL(18,8), -- Base NEFT
      (CASE WHEN streak_count >= 7 THEN 5.0 ELSE 0.0 END)::DECIMAL(18,8), -- Bonus NEFT
      (50 + (streak_count * 5))::INTEGER, -- Base XP
      (CASE WHEN streak_count >= 7 THEN 25 ELSE 0 END)::INTEGER, -- Bonus XP
      NULL::JSONB,
      (CASE 
        WHEN streak_count >= 30 THEN 'Legendary'
        WHEN streak_count >= 14 THEN 'Epic'
        WHEN streak_count >= 7 THEN 'Rare'
        ELSE 'Basic'
      END)::TEXT,
      FALSE;
  END IF;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| calculate_daily_rewards                     | 
DECLARE
  staked_nft RECORD;
  staked_token RECORD;
  reward_amount NUMERIC(18,8);
  current_date DATE := CURRENT_DATE;
BEGIN
  -- Calculate NFT staking rewards
  FOR staked_nft IN 
    SELECT id, wallet_address, daily_reward, last_reward_calculated
    FROM staked_nfts
    WHERE last_reward_calculated::date < current_date
  LOOP
    -- Insert reward record
    INSERT INTO staking_rewards (
      wallet_address,
      reward_type,
      source_id,
      reward_amount,
      reward_date
    ) VALUES (
      staked_nft.wallet_address,
      'nft_staking',
      staked_nft.id::text,
      staked_nft.daily_reward,
      current_date
    );
    
    -- Update last reward calculated
    UPDATE staked_nfts 
    SET last_reward_calculated = NOW()
    WHERE id = staked_nft.id;
  END LOOP;
  
  -- Calculate token staking rewards
  FOR staked_token IN 
    SELECT id, wallet_address, daily_reward, last_reward_calculated
    FROM staked_tokens
    WHERE last_reward_calculated::date < current_date
  LOOP
    -- Insert reward record
    INSERT INTO staking_rewards (
      wallet_address,
      reward_type,
      source_id,
      reward_amount,
      reward_date
    ) VALUES (
      staked_token.wallet_address,
      'token_staking',
      staked_token.id::text,
      staked_token.daily_reward,
      current_date
    );
    
    -- Update last reward calculated
    UPDATE staked_tokens 
    SET last_reward_calculated = NOW()
    WHERE id = staked_token.id;
  END LOOP;
  
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| calculate_level_from_xp                     | 
DECLARE
    xp_thresholds INTEGER[] := ARRAY[
        0, 83, 174, 276, 388, 512, 650, 801, 969, 1156,
        1358, 1584, 1833, 2107, 2411, 2746, 3115, 3523, 3973, 4470,
        5018, 5624, 6291, 7028, 7842, 8740, 9730, 10824, 12031, 13363,
        14831, 16456, 18247, 20224, 22406, 24815, 27473, 30408, 33648, 37224,
        41171, 45529, 50339, 55649, 61512, 67983, 75127, 83014, 91721, 101333,
        111945, 123660, 136591, 150872, 166636, 184040, 203254, 224465, 247886, 273742,
        302288, 333804, 368599, 407015, 449428, 496254, 547953, 605032, 668051, 737627,
        814445, 899257, 992895, 1096278, 1210421, 1336443, 1475581, 1629200, 1798808, 1986068
    ];
    level INTEGER := 1;
    i INTEGER;
BEGIN
    -- Handle negative XP
    IF total_xp < 0 THEN
        RETURN 1;
    END IF;
    
    -- Find the highest level where XP requirement is met
    FOR i IN REVERSE array_upper(xp_thresholds, 1)..1 LOOP
        IF total_xp >= xp_thresholds[i] THEN
            level := i;
            EXIT;
        END IF;
    END LOOP;
    
    RETURN level;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| calculate_pending_staking_rewards           | 
DECLARE
    nft_rewards DECIMAL(18,8) := 0;
    token_rewards DECIMAL(18,8) := 0;
    total_pending DECIMAL(18,8) := 0;
    days_staked INTEGER;
BEGIN
    -- Calculate NFT staking rewards (days staked × daily_reward)
    SELECT COALESCE(SUM(
        daily_reward * EXTRACT(DAY FROM (NOW() - staked_at::timestamp))
    ), 0) INTO nft_rewards
    FROM staked_nfts 
    WHERE wallet_address = user_wallet;
    
    -- Calculate token staking rewards (days staked × daily_reward)
    SELECT COALESCE(SUM(
        daily_reward * EXTRACT(DAY FROM (NOW() - staked_at::timestamp))
    ), 0) INTO token_rewards
    FROM staked_tokens 
    WHERE wallet_address = user_wallet;
    
    total_pending := nft_rewards + token_rewards;
    
    RETURN json_build_object(
        'success', true,
        'nft_rewards', nft_rewards,
        'token_rewards', token_rewards,
        'total_pending', total_pending,
        'calculation_method', 'automatic_real_time'
    );
    
EXCEPTION WHEN OTHERS THEN
    RETURN json_build_object(
        'success', false,
        'error', SQLERRM,
        'message', 'Failed to calculate pending rewards'
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| can_claim_daily_reward                      | 
DECLARE
  user_record RECORD;
  hours_since_last_claim NUMERIC;
BEGIN
  -- Get user streak record
  SELECT * INTO user_record FROM user_streaks WHERE wallet_address = user_wallet;

  -- If no previous claims, can claim immediately
  IF user_record IS NULL OR user_record.last_claimed_at IS NULL THEN
    RETURN QUERY SELECT TRUE, 0::NUMERIC, 'Ready to claim'::TEXT;
    RETURN;
  END IF;

  -- Calculate hours since last claim
  SELECT EXTRACT(EPOCH FROM (NOW() - user_record.last_claimed_at)) / 3600 INTO hours_since_last_claim;
  
  -- Check if 24 hours have passed
  IF hours_since_last_claim >= 24 THEN
    RETURN QUERY SELECT TRUE, 0::NUMERIC, 'Ready to claim'::TEXT;
  ELSE
    RETURN QUERY SELECT 
      FALSE, 
      ROUND(24 - hours_since_last_claim, 1), 
      CONCAT('Must wait ', ROUND(24 - hours_since_last_claim, 1), ' more hours')::TEXT;
  END IF;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| can_claim_daily_reward_fast                 | 
BEGIN
  RETURN NOT EXISTS (
    SELECT 1 FROM daily_claims 
    WHERE wallet_address = user_wallet 
    AND claim_date = CURRENT_DATE
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| can_claim_project_reward                    | 
BEGIN
  RETURN NOT EXISTS (
    SELECT 1 FROM campaign_reward_claims 
    WHERE wallet_address = user_wallet AND project_id = proj_id
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| can_claim_project_reward                    | 
DECLARE
    already_claimed BOOLEAN := false;
    total_tasks INTEGER := 0;
    completed_tasks INTEGER := 0;
    project_ended BOOLEAN := false;
BEGIN
    -- Check if project has ended (if projects table exists)
    BEGIN
        SELECT (end_date IS NOT NULL AND end_date < NOW())
        INTO project_ended
        FROM projects 
        WHERE id = proj_id AND is_active = true;
    EXCEPTION WHEN OTHERS THEN
        project_ended := true; -- Assume ended if can't check
    END;
    
    -- If project hasn't ended, user cannot claim
    IF NOT project_ended THEN
        RETURN false;
    END IF;
    
    -- Check if user has already claimed rewards
    BEGIN
        SELECT EXISTS(
            SELECT 1 FROM campaign_reward_claims 
            WHERE wallet_address = user_wallet AND project_id = proj_id
        ) INTO already_claimed;
    EXCEPTION WHEN OTHERS THEN
        already_claimed := false;
    END;
    
    IF already_claimed THEN
        RETURN false;
    END IF;
    
    -- Get total and completed tasks
    BEGIN
        SELECT COUNT(*) INTO total_tasks
        FROM project_tasks 
        WHERE project_id = proj_id AND is_active = true;
        
        SELECT COUNT(*) INTO completed_tasks
        FROM user_task_completions utc
        JOIN project_tasks pt ON utc.task_id = pt.id
        WHERE utc.wallet_address = user_wallet 
            AND pt.project_id = proj_id 
            AND utc.completed = true
            AND pt.is_active = true;
    EXCEPTION WHEN OTHERS THEN
        RETURN false;
    END;
    
    -- User can claim if they completed all tasks
    RETURN total_tasks > 0 AND completed_tasks = total_tasks;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| check_existing_user_by_wallet               | 
BEGIN
  RETURN QUERY
  -- Check in primary wallet addresses (wallet_address column - primary key)
  SELECT 
    u.wallet_address as existing_user_wallet_address,
    u.display_name as existing_user_display_name,
    u.email as existing_user_email,
    'primary_wallet' as connection_type,
    jsonb_build_object(
      'wallet_type', u.wallet_type,
      'provider', u.provider,
      'social_provider', u.social_provider,
      'is_primary', true
    ) as connection_details
  FROM users u
  WHERE u.wallet_address = wallet_address_to_check
  
  UNION ALL
  
  -- Check in linked wallet addresses (linked_wallet_addresses column)
  SELECT 
    u.wallet_address as existing_user_wallet_address,
    u.display_name as existing_user_display_name,
    u.email as existing_user_email,
    'linked_wallet' as connection_type,
    jsonb_build_object(
      'linked_wallet_address', linked_wallet->>'address',
      'linked_wallet_type', linked_wallet->>'wallet_type',
      'is_primary', false
    ) as connection_details
  FROM users u,
       jsonb_array_elements(COALESCE(u.linked_wallet_addresses, '[]'::jsonb)) AS linked_wallet
  WHERE linked_wallet->>'address' = wallet_address_to_check
  
  UNION ALL
  
  -- Check in linked social accounts (linked_social_accounts column)
  SELECT 
    u.wallet_address as existing_user_wallet_address,
    u.display_name as existing_user_display_name,
    u.email as existing_user_email,
    'linked_social' as connection_type,
    jsonb_build_object(
      'linked_social_provider', linked_social->>'provider',
      'linked_social_address', linked_social->>'social_address',
      'is_primary', false
    ) as connection_details
  FROM users u,
       jsonb_array_elements(COALESCE(u.linked_social_accounts, '[]'::jsonb)) AS linked_social
  WHERE linked_social->>'social_address' = wallet_address_to_check;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| check_linked_account_exists                 | 
BEGIN
  IF account_type = 'wallet' THEN
    RETURN EXISTS (
      SELECT 1 FROM users 
      WHERE linked_wallet_addresses @> jsonb_build_array(account_id)
      AND (exclude_user_id IS NULL OR id != exclude_user_id)
    );
  ELSIF account_type = 'social' THEN
    RETURN EXISTS (
      SELECT 1 FROM users 
      WHERE linked_social_accounts @> jsonb_build_array(account_id)
      AND (exclude_user_id IS NULL OR id != exclude_user_id)
    );
  END IF;
  RETURN FALSE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| check_reward_system_status                  | 
DECLARE
    manual_rewards_count INTEGER;
    auto_rewards_count INTEGER;
    total_stakers INTEGER;
BEGIN
    -- Count manually generated rewards (from admin function)
    SELECT COUNT(*) INTO manual_rewards_count
    FROM staking_rewards 
    WHERE reward_date = CURRENT_DATE;
    
    -- Count users with staked assets
    SELECT COUNT(DISTINCT wallet_address) INTO total_stakers
    FROM (
        SELECT wallet_address FROM staked_nfts
        UNION
        SELECT wallet_address FROM staked_tokens
    ) AS all_stakers;
    
    -- Count automatic rewards (should be 0 if manual was run)
    SELECT COUNT(*) INTO auto_rewards_count
    FROM staking_rewards 
    WHERE reward_date = CURRENT_DATE 
    AND created_at > (SELECT MAX(created_at) FROM staking_rewards WHERE reward_date = CURRENT_DATE - INTERVAL '1 day');
    
    RETURN json_build_object(
        'manual_rewards_today', manual_rewards_count,
        'total_stakers', total_stakers,
        'auto_rewards_today', auto_rewards_count,
        'status', CASE 
            WHEN manual_rewards_count > 0 THEN 'manual_generation_detected'
            ELSE 'automatic_system_active'
        END,
        'recommendation', CASE 
            WHEN manual_rewards_count > 0 THEN 'switch_to_automatic_calculation'
            ELSE 'system_working_correctly'
        END
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| claim_achievement_reward                    | 
DECLARE
  achievement_record RECORD;
  user_achievement_record RECORD;
BEGIN
  -- Get achievement details
  SELECT * INTO achievement_record
  FROM achievements_master am
  WHERE am.achievement_key = achievement_key_param AND am.is_active = TRUE;
  
  IF achievement_record IS NULL THEN
    RETURN QUERY SELECT FALSE, 'Achievement not found or inactive', 0::DECIMAL(18,8), 0, NULL::TEXT;
    RETURN;
  END IF;
  
  -- Get user achievement status
  SELECT * INTO user_achievement_record
  FROM user_achievements ua
  WHERE ua.wallet_address = user_wallet AND ua.achievement_key = achievement_key_param;
  
  IF user_achievement_record IS NULL THEN
    RETURN QUERY SELECT FALSE, 'Achievement not started', 0::DECIMAL(18,8), 0, NULL::TEXT;
    RETURN;
  END IF;
  
  -- Check if already claimed
  IF user_achievement_record.claimed_at IS NOT NULL THEN
    RETURN QUERY SELECT FALSE, 'Achievement already claimed', 0::DECIMAL(18,8), 0, NULL::TEXT;
    RETURN;
  END IF;
  
  -- Check if achievement is completed
  IF user_achievement_record.status != 'completed' THEN
    RETURN QUERY SELECT FALSE, 'Achievement not completed yet', 0::DECIMAL(18,8), 0, NULL::TEXT;
    RETURN;
  END IF;
  
  -- Mark as claimed
  UPDATE user_achievements 
  SET claimed_at = NOW(), updated_at = NOW()
  WHERE wallet_address = user_wallet AND achievement_key = achievement_key_param;
  
  -- Update user balance with achievement rewards (INCLUDING available_neft)
  INSERT INTO user_balances (
    wallet_address, 
    total_neft_claimed, 
    total_xp_earned, 
    available_neft,
    last_updated
  )
  VALUES (
    user_wallet, 
    achievement_record.neft_reward, 
    achievement_record.xp_reward,
    achievement_record.neft_reward, -- Add to available_neft too
    NOW()
  )
  ON CONFLICT (wallet_address)
  DO UPDATE SET
    total_neft_claimed = user_balances.total_neft_claimed + achievement_record.neft_reward,
    total_xp_earned = user_balances.total_xp_earned + achievement_record.xp_reward,
    available_neft = user_balances.available_neft + achievement_record.neft_reward, -- FIXED: Add to available_neft
    last_updated = NOW();
  
  -- Return success with rewards
  RETURN QUERY SELECT 
    TRUE, 
    'Achievement claimed successfully!', 
    achievement_record.neft_reward,
    achievement_record.xp_reward,
    achievement_record.nft_reward;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| claim_referral_tier_reward                  | 
DECLARE
  user_referrals INTEGER;
  tier_neft_reward DECIMAL(18,2);
  tier_xp_reward INTEGER;
  result JSON;
BEGIN
  -- Get user's current referral count
  SELECT total_referrals INTO user_referrals
  FROM referral_stats
  WHERE wallet_address = user_wallet;
  
  IF user_referrals IS NULL THEN
    RETURN json_build_object('success', false, 'message', 'User not found');
  END IF;
  
  -- Check if tier is already claimed
  IF EXISTS (SELECT 1 FROM referral_tier_claims WHERE wallet_address = user_wallet AND tier_level = claim_referral_tier_reward.tier_level) THEN
    RETURN json_build_object('success', false, 'message', 'Tier already claimed');
  END IF;
  
  -- Define tier rewards
  IF tier_level = 1 THEN
    IF user_referrals < 1 THEN
      RETURN json_build_object('success', false, 'message', 'Not enough referrals for this tier');
    END IF;
    tier_neft_reward := 25;
    tier_xp_reward := 50;
  ELSIF tier_level = 2 THEN
    IF user_referrals < 5 THEN
      RETURN json_build_object('success', false, 'message', 'Not enough referrals for this tier');
    END IF;
    tier_neft_reward := 50;
    tier_xp_reward := 100;
  ELSIF tier_level = 3 THEN
    IF user_referrals < 10 THEN
      RETURN json_build_object('success', false, 'message', 'Not enough referrals for this tier');
    END IF;
    tier_neft_reward := 150;
    tier_xp_reward := 300;
  ELSE
    RETURN json_build_object('success', false, 'message', 'Invalid tier level');
  END IF;
  
  -- Record the tier claim
  INSERT INTO referral_tier_claims (wallet_address, tier_level, neft_reward, xp_reward)
  VALUES (user_wallet, tier_level, tier_neft_reward, tier_xp_reward);
  
  -- Update last tier claimed
  UPDATE referral_stats 
  SET last_tier_claimed = GREATEST(last_tier_claimed, tier_level)
  WHERE wallet_address = user_wallet;
  
  SELECT json_build_object(
    'success', true,
    'message', 'Tier reward claimed successfully',
    'neft_reward', tier_neft_reward,
    'xp_reward', tier_xp_reward,
    'tier_claimed', tier_level
  ) INTO result;
  
  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| claim_staking_rewards                       | 
DECLARE
    total_claimable DECIMAL(18,8) := 0;
BEGIN
    -- Get total unclaimed rewards
    SELECT COALESCE(SUM(total_rewards), 0)
    INTO total_claimable
    FROM staking_rewards
    WHERE wallet_address = user_wallet AND claimed = FALSE;
    
    IF total_claimable <= 0 THEN
        RETURN json_build_object('success', false, 'error', 'No rewards available to claim');
    END IF;
    
    -- Mark rewards as claimed
    UPDATE staking_rewards
    SET claimed = TRUE
    WHERE wallet_address = user_wallet AND claimed = FALSE;
    
    -- Add rewards to user balance
    INSERT INTO user_balances (wallet_address, total_neft_claimed, available_neft, total_xp_earned)
    VALUES (user_wallet, total_claimable, total_claimable, 0)
    ON CONFLICT (wallet_address)
    DO UPDATE SET
        total_neft_claimed = user_balances.total_neft_claimed + EXCLUDED.total_neft_claimed,
        available_neft = user_balances.available_neft + EXCLUDED.available_neft,
        last_updated = NOW();
    
    RETURN json_build_object(
        'success', true,
        'message', format('Successfully claimed %s NEFT rewards!', total_claimable),
        'claimed_amount', total_claimable
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| commit_transaction                          | 
BEGIN
    -- Commit transaction (this is implicit in Supabase)
    RAISE NOTICE 'Transaction committed';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| compare_balance_totals                      | 
DECLARE
  campaign_neft DECIMAL(18,8) := 0;
  campaign_xp INTEGER := 0;
  daily_neft DECIMAL(18,8) := 0;
  daily_xp INTEGER := 0;
  achievement_neft DECIMAL(18,8) := 0;
  achievement_xp INTEGER := 0;
  staking_neft DECIMAL(18,8) := 0;
  
  table_neft DECIMAL(18,8) := 0;
  table_xp INTEGER := 0;
  
  manual_total_neft DECIMAL(18,8);
  manual_total_xp INTEGER;
BEGIN
  -- Get manual sums from each table
  SELECT COALESCE(SUM(neft_reward), 0), COALESCE(SUM(xp_reward), 0)
  INTO campaign_neft, campaign_xp
  FROM campaign_reward_claims WHERE wallet_address = user_wallet;
  
  SELECT COALESCE(SUM(total_neft_reward), 0), COALESCE(SUM(total_xp_reward), 0)
  INTO daily_neft, daily_xp
  FROM daily_claims WHERE wallet_address = user_wallet;
  
  SELECT COALESCE(SUM(am.neft_reward), 0), COALESCE(SUM(am.xp_reward), 0)
  INTO achievement_neft, achievement_xp
  FROM user_achievements ua
  JOIN achievements_master am ON ua.achievement_key = am.achievement_key
  WHERE ua.wallet_address = user_wallet AND ua.status = 'completed' AND ua.claimed_at IS NOT NULL;
  
  SELECT COALESCE(SUM(reward_amount), 0)
  INTO staking_neft
  FROM staking_rewards WHERE wallet_address = user_wallet AND is_claimed = true;
  
  -- Get values from user_balances table
  SELECT COALESCE(total_neft_claimed, 0), COALESCE(total_xp_earned, 0)
  INTO table_neft, table_xp
  FROM user_balances WHERE wallet_address = user_wallet;
  
  -- Calculate manual totals
  manual_total_neft := campaign_neft + daily_neft + achievement_neft + staking_neft;
  manual_total_xp := campaign_xp + daily_xp + achievement_xp;
  
  -- Return comparison results
  RETURN QUERY VALUES
    ('Campaign NEFT', campaign_neft, 0::DECIMAL(18,8), campaign_neft, true),
    ('Daily Claims NEFT', daily_neft, 0::DECIMAL(18,8), daily_neft, true),
    ('Achievement NEFT', achievement_neft, 0::DECIMAL(18,8), achievement_neft, true),
    ('Staking NEFT', staking_neft, 0::DECIMAL(18,8), staking_neft, true),
    ('--- TOTALS ---', 0::DECIMAL(18,8), 0::DECIMAL(18,8), 0::DECIMAL(18,8), true),
    ('Total NEFT (Manual)', manual_total_neft, table_neft, manual_total_neft - table_neft, manual_total_neft = table_neft),
    ('Total XP (Manual)', manual_total_xp::DECIMAL(18,8), table_xp::DECIMAL(18,8), (manual_total_xp - table_xp)::DECIMAL(18,8), manual_total_xp = table_xp);
    
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| complete_project_task                       | 
DECLARE
    result JSON;
    task_exists BOOLEAN;
    already_completed BOOLEAN;
    participation_exists BOOLEAN;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM project_tasks pt
        JOIN projects p ON p.id = pt.project_id
        WHERE pt.id = p_task_id 
            AND pt.project_id = p_project_id 
            AND pt.is_active = true 
            AND p.is_active = true
    ) INTO task_exists;
    
    IF NOT task_exists THEN
        RETURN json_build_object('success', false, 'error', 'Task not found or inactive');
    END IF;
    
    SELECT EXISTS(
        SELECT 1 FROM user_task_completions
        WHERE wallet_address = p_wallet_address 
            AND task_id = p_task_id 
            AND completed = true
    ) INTO already_completed;
    
    IF already_completed THEN
        RETURN json_build_object('success', false, 'error', 'Task already completed');
    END IF;
    
    SELECT EXISTS(
        SELECT 1 FROM user_participations
        WHERE wallet_address = p_wallet_address AND project_id = p_project_id
    ) INTO participation_exists;
    
    IF NOT participation_exists THEN
        INSERT INTO user_participations (wallet_address, project_id)
        VALUES (p_wallet_address, p_project_id);
    END IF;
    
    INSERT INTO user_task_completions (
        wallet_address, project_id, task_id, completed, completed_at, verification_data
    ) VALUES (
        p_wallet_address, p_project_id, p_task_id, true, NOW(), p_verification_data
    )
    ON CONFLICT (wallet_address, task_id) 
    DO UPDATE SET 
        completed = true,
        completed_at = NOW(),
        verification_data = p_verification_data,
        updated_at = NOW();
    
    SELECT json_build_object(
        'success', true,
        'completed_tasks_count', up.completed_tasks_count,
        'total_tasks_count', up.total_tasks_count,
        'completion_percentage', up.completion_percentage
    ) INTO result
    FROM user_participations up
    WHERE up.wallet_address = p_wallet_address AND up.project_id = p_project_id;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| connection_exists                           | 
DECLARE
  connection_found BOOLEAN := FALSE;
BEGIN
  IF connection_type = 'social' THEN
    SELECT EXISTS(
      SELECT 1 FROM users u
      WHERE u.wallet_address = user_wallet_address
      AND (
        u.social_provider = connection_identifier
        OR jsonb_path_exists(
          COALESCE(u.linked_social_accounts, '[]'::jsonb), 
          ('$[*] ? (@.provider == "' || connection_identifier || '")')::jsonpath
        )
      )
    ) INTO connection_found;
  ELSIF connection_type = 'wallet' THEN
    SELECT EXISTS(
      SELECT 1 FROM users u
      WHERE u.wallet_address = user_wallet_address
      AND (
        u.wallet_type = connection_identifier
        OR jsonb_path_exists(
          COALESCE(u.linked_wallet_addresses, '[]'::jsonb), 
          ('$[*] ? (@.wallet_type == "' || connection_identifier || '")')::jsonpath
        )
      )
    ) INTO connection_found;
  END IF;
  
  RETURN connection_found;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| create_nft_tables_if_not_exists             | 
BEGIN
    -- This function is called from the service to ensure tables exist
    -- The actual table creation is handled by the schema above
    RAISE NOTICE 'NFT tables initialization check completed';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| debug_balance_aggregation                   | 
BEGIN
  -- Return detailed breakdown from each source
  
  -- 1. Campaign Rewards
  RETURN QUERY
  SELECT 
    'campaign_reward_claims'::TEXT as source_name,
    COALESCE(SUM(neft_reward), 0)::DECIMAL(18,8) as neft_amount,
    COALESCE(SUM(xp_reward), 0)::INTEGER as xp_amount,
    COUNT(*)::INTEGER as record_count,
    jsonb_agg(
      jsonb_build_object(
        'project_id', project_id,
        'neft_reward', neft_reward,
        'xp_reward', xp_reward,
        'claimed_at', claimed_at
      )
    ) as details
  FROM campaign_reward_claims 
  WHERE wallet_address = user_wallet;
  
  -- 2. Daily Claims
  RETURN QUERY
  SELECT 
    'daily_claims'::TEXT as source_name,
    COALESCE(SUM(total_neft_reward), 0)::DECIMAL(18,8) as neft_amount,
    COALESCE(SUM(total_xp_reward), 0)::INTEGER as xp_amount,
    COUNT(*)::INTEGER as record_count,
    jsonb_agg(
      jsonb_build_object(
        'claim_date', claim_date,
        'streak_count', streak_count,
        'total_neft_reward', total_neft_reward,
        'total_xp_reward', total_xp_reward,
        'claimed_at', claimed_at
      )
    ) as details
  FROM daily_claims 
  WHERE wallet_address = user_wallet;
  
  -- 3. Achievement Rewards (claimed only)
  RETURN QUERY
  SELECT 
    'user_achievements'::TEXT as source_name,
    COALESCE(SUM(am.neft_reward), 0)::DECIMAL(18,8) as neft_amount,
    COALESCE(SUM(am.xp_reward), 0)::INTEGER as xp_amount,
    COUNT(*)::INTEGER as record_count,
    jsonb_agg(
      jsonb_build_object(
        'achievement_key', ua.achievement_key,
        'title', am.title,
        'neft_reward', am.neft_reward,
        'xp_reward', am.xp_reward,
        'status', ua.status,
        'claimed_at', ua.claimed_at
      )
    ) as details
  FROM user_achievements ua
  JOIN achievements_master am ON ua.achievement_key = am.achievement_key
  WHERE ua.wallet_address = user_wallet 
    AND ua.status = 'completed' 
    AND ua.claimed_at IS NOT NULL;
  
  -- 4. Staking Rewards (claimed only)
  RETURN QUERY
  SELECT 
    'staking_rewards'::TEXT as source_name,
    COALESCE(SUM(reward_amount), 0)::DECIMAL(18,8) as neft_amount,
    0::INTEGER as xp_amount, -- Staking rewards are NEFT only
    COUNT(*)::INTEGER as record_count,
    jsonb_agg(
      jsonb_build_object(
        'reward_type', reward_type,
        'reward_amount', reward_amount,
        'reward_date', reward_date,
        'is_claimed', is_claimed,
        'claimed_at', claimed_at
      )
    ) as details
  FROM staking_rewards 
  WHERE wallet_address = user_wallet 
    AND is_claimed = true;
  
  -- 5. Current Balance in user_balances table
  RETURN QUERY
  SELECT 
    'user_balances_table'::TEXT as source_name,
    COALESCE(total_neft_claimed, 0)::DECIMAL(18,8) as neft_amount,
    COALESCE(total_xp_earned, 0)::INTEGER as xp_amount,
    1::INTEGER as record_count,
    jsonb_build_object(
      'total_neft_claimed', total_neft_claimed,
      'total_xp_earned', total_xp_earned,
      'available_neft', available_neft,
      'last_updated', last_updated
    ) as details
  FROM user_balances 
  WHERE wallet_address = user_wallet;
  
  -- 6. Staked Tokens (affects available_neft)
  RETURN QUERY
  SELECT 
    'staked_tokens'::TEXT as source_name,
    COALESCE(SUM(amount), 0)::DECIMAL(18,8) as neft_amount,
    0::INTEGER as xp_amount,
    COUNT(*)::INTEGER as record_count,
    jsonb_agg(
      jsonb_build_object(
        'amount', amount,
        'apr_rate', apr_rate,
        'daily_reward', daily_reward,
        'staked_at', staked_at
      )
    ) as details
  FROM staked_tokens 
  WHERE wallet_address = user_wallet;
  
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| debug_simple_staking                        | 
DECLARE
    result JSON;
    current_time TIMESTAMP WITH TIME ZONE := NOW();
BEGIN
    SELECT json_build_object(
        'current_time', current_time,
        'wallet', user_wallet,
        'nft_stakes', (
            SELECT COALESCE(json_agg(json_build_object(
                'nft_id', nft_id,
                'daily_reward', daily_reward,
                'staked_at', staked_at,
                'hours_staked', EXTRACT(EPOCH FROM (current_time - staked_at)) / 3600.0,
                'pending_now', daily_reward * EXTRACT(EPOCH FROM (current_time - staked_at)) / 86400.0
            )), '[]'::json)
            FROM staked_nfts WHERE wallet_address = user_wallet
        ),
        'token_stakes', (
            SELECT COALESCE(json_agg(json_build_object(
                'amount', amount,
                'daily_reward', daily_reward,
                'staked_at', staked_at,
                'hours_staked', EXTRACT(EPOCH FROM (current_time - staked_at)) / 3600.0,
                'pending_now', daily_reward * EXTRACT(EPOCH FROM (current_time - staked_at)) / 86400.0
            )), '[]'::json)
            FROM staked_tokens WHERE wallet_address = user_wallet
        )
    ) INTO result;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| debug_user_achievements                     | 
BEGIN
  RETURN QUERY
  SELECT 
    am.achievement_key,
    am.title,
    COALESCE(ua.status, 'locked'::achievement_status) as status,
    COALESCE(ua.current_progress, 0) as current_progress,
    am.required_count,
    CASE 
      WHEN COALESCE(ua.current_progress, 0) >= am.required_count THEN 100
      WHEN am.required_count > 0 THEN ROUND((COALESCE(ua.current_progress, 0)::DECIMAL / am.required_count::DECIMAL) * 100)
      ELSE 0
    END::INTEGER as progress_percentage,
    ua.completed_at,
    ua.claimed_at,
    (COALESCE(ua.status, 'locked'::achievement_status) = 'completed' AND ua.claimed_at IS NULL) as can_claim
  FROM achievements_master am
  LEFT JOIN user_achievements ua ON am.achievement_key = ua.achievement_key 
    AND ua.wallet_address = user_wallet
  WHERE am.is_active = TRUE
  ORDER BY am.sort_order ASC, am.category ASC;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| debug_user_balance                          | 
DECLARE
  result JSON;
  campaign_neft DECIMAL(18,8) := 0;
  campaign_xp INTEGER := 0;
  daily_neft DECIMAL(18,8) := 0;
  daily_xp INTEGER := 0;
  achievement_neft DECIMAL(18,8) := 0;
  achievement_xp INTEGER := 0;
BEGIN
  -- Debug: Get campaign rewards
  SELECT 
    COALESCE(total_neft_claimed, 0),
    COALESCE(total_xp_earned, 0)
  INTO campaign_neft, campaign_xp
  FROM user_balances 
  WHERE wallet_address = user_wallet;

  -- Debug: Get daily claims totals
  SELECT 
    COALESCE(SUM(total_neft_reward), 0),
    COALESCE(SUM(total_xp_reward), 0)
  INTO daily_neft, daily_xp
  FROM daily_claims 
  WHERE wallet_address = user_wallet;

  -- Debug: Get achievement rewards
  SELECT 
    COALESCE(SUM(ua.neft_reward), 0),
    COALESCE(SUM(ua.xp_reward), 0)
  INTO achievement_neft, achievement_xp
  FROM user_achievements ua
  WHERE ua.wallet_address = user_wallet 
    AND ua.status = 'completed' 
    AND ua.claimed_at IS NOT NULL;

  -- Return debug info
  SELECT json_build_object(
    'wallet_address', user_wallet,
    'campaign_neft', campaign_neft,
    'campaign_xp', campaign_xp,
    'daily_neft', daily_neft,
    'daily_xp', daily_xp,
    'achievement_neft', achievement_neft,
    'achievement_xp', achievement_xp,
    'total_neft', campaign_neft + daily_neft + achievement_neft,
    'total_xp', campaign_xp + daily_xp + achievement_xp
  ) INTO result;

  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| debug_user_search                           | 
DECLARE
  primary_result RECORD;
  social_result RECORD;
  wallet_result RECORD;
BEGIN
  -- Step 1: Check primary wallet
  SELECT u.id, u.wallet_address INTO primary_result
  FROM users u WHERE u.wallet_address = search_address;
  
  RETURN QUERY SELECT 
    'primary_check'::TEXT,
    primary_result.id,
    primary_result.wallet_address,
    'primary'::TEXT,
    jsonb_build_object('found', primary_result.id IS NOT NULL);
  
  -- Step 2: Check linked social accounts
  SELECT u.id, u.wallet_address INTO social_result
  FROM users u,
  jsonb_array_elements(COALESCE(u.linked_social_accounts, '[]'::jsonb)) AS social_conn
  WHERE social_conn->>'social_address' = search_address;
  
  RETURN QUERY SELECT 
    'social_check'::TEXT,
    social_result.id,
    social_result.wallet_address,
    'linked_social'::TEXT,
    jsonb_build_object('found', social_result.id IS NOT NULL);
  
  -- Step 3: Check linked wallets
  SELECT u.id, u.wallet_address INTO wallet_result
  FROM users u,
  jsonb_array_elements(COALESCE(u.linked_wallet_addresses, '[]'::jsonb)) AS wallet_conn
  WHERE wallet_conn->>'address' = search_address;
  
  RETURN QUERY SELECT 
    'wallet_check'::TEXT,
    wallet_result.id,
    wallet_result.wallet_address,
    'linked_wallet'::TEXT,
    jsonb_build_object('found', wallet_result.id IS NOT NULL);
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| find_user_by_any_address                    | 
DECLARE
  found_record RECORD;
BEGIN
  -- First check if it's the primary wallet address
  SELECT 
    u.id,
    u.wallet_address,
    u.email,
    u.display_name,
    u.avatar_url,
    u.provider,
    u.social_provider,
    u.wallet_type,
    u.metadata,
    u.linked_wallet_addresses,
    u.linked_social_accounts,
    u.created_at,
    u.last_login,
    u.updated_at
  INTO found_record
  FROM users u
  WHERE u.wallet_address = search_address;
  
  IF FOUND THEN
    RETURN QUERY
    SELECT 
      found_record.id as user_id,
      found_record.wallet_address,
      found_record.email,
      found_record.display_name,
      found_record.avatar_url,
      found_record.provider,
      found_record.social_provider,
      found_record.wallet_type,
      found_record.metadata,
      found_record.linked_wallet_addresses,
      found_record.linked_social_accounts,
      found_record.created_at,
      found_record.last_login,
      found_record.updated_at,
      'primary_wallet'::TEXT as connection_type,
      true as is_primary;
    RETURN;
  END IF;
  
  -- Check linked social accounts
  SELECT 
    u.id,
    u.wallet_address,
    u.email,
    u.display_name,
    u.avatar_url,
    u.provider,
    u.social_provider,
    u.wallet_type,
    u.metadata,
    u.linked_wallet_addresses,
    u.linked_social_accounts,
    u.created_at,
    u.last_login,
    u.updated_at
  INTO found_record
  FROM users u,
  jsonb_array_elements(COALESCE(u.linked_social_accounts, '[]'::jsonb)) AS social_conn
  WHERE social_conn->>'social_address' = search_address;
  
  IF FOUND THEN
    RETURN QUERY
    SELECT 
      found_record.id as user_id,
      found_record.wallet_address,
      found_record.email,
      found_record.display_name,
      found_record.avatar_url,
      found_record.provider,
      found_record.social_provider,
      found_record.wallet_type,
      found_record.metadata,
      found_record.linked_wallet_addresses,
      found_record.linked_social_accounts,
      found_record.created_at,
      found_record.last_login,
      found_record.updated_at,
      'linked_social'::TEXT as connection_type,
      false as is_primary;
    RETURN;
  END IF;
  
  -- Check linked wallet addresses
  SELECT 
    u.id,
    u.wallet_address,
    u.email,
    u.display_name,
    u.avatar_url,
    u.provider,
    u.social_provider,
    u.wallet_type,
    u.metadata,
    u.linked_wallet_addresses,
    u.linked_social_accounts,
    u.created_at,
    u.last_login,
    u.updated_at
  INTO found_record
  FROM users u,
  jsonb_array_elements(COALESCE(u.linked_wallet_addresses, '[]'::jsonb)) AS wallet_conn
  WHERE wallet_conn->>'address' = search_address;
  
  IF FOUND THEN
    RETURN QUERY
    SELECT 
      found_record.id as user_id,
      found_record.wallet_address,
      found_record.email,
      found_record.display_name,
      found_record.avatar_url,
      found_record.provider,
      found_record.social_provider,
      found_record.wallet_type,
      found_record.metadata,
      found_record.linked_wallet_addresses,
      found_record.linked_social_accounts,
      found_record.created_at,
      found_record.last_login,
      found_record.updated_at,
      'linked_wallet'::TEXT as connection_type,
      false as is_primary;
    RETURN;
  END IF;
  
  -- No user found with this address
  RETURN;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| find_user_by_any_connection                 | 
BEGIN
  -- First check if it's the primary wallet address
  RETURN QUERY
  SELECT u.id, u.wallet_address, u.email, u.display_name, u.avatar_url, 
         u.provider, u.social_provider, u.wallet_type, u.metadata,
         u.created_at, u.last_login, u.updated_at
  FROM users u
  WHERE u.wallet_address = search_address;
  
  -- If not found, check linked social accounts
  IF NOT FOUND THEN
    RETURN QUERY
    SELECT u.id, u.wallet_address, u.email, u.display_name, u.avatar_url, 
           u.provider, u.social_provider, u.wallet_type, u.metadata,
           u.created_at, u.last_login, u.updated_at
    FROM users u,
    jsonb_array_elements(u.linked_social_accounts) AS social_conn
    WHERE social_conn->>'social_address' = search_address;
  END IF;
  
  -- If still not found, check linked wallet addresses
  IF NOT FOUND THEN
    RETURN QUERY
    SELECT u.id, u.wallet_address, u.email, u.display_name, u.avatar_url, 
           u.provider, u.social_provider, u.wallet_type, u.metadata,
           u.created_at, u.last_login, u.updated_at
    FROM users u,
    jsonb_array_elements(u.linked_wallet_addresses) AS wallet_conn
    WHERE wallet_conn->>'address' = search_address;
  END IF;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| find_wallet_by_referral_code                | 
DECLARE
  wallet_address TEXT;
BEGIN
  SELECT rc.wallet_address INTO wallet_address
  FROM referral_codes rc
  WHERE rc.referral_code = find_wallet_by_referral_code.referral_code;
  
  IF wallet_address IS NULL THEN
    RETURN json_build_object(
      'success', false,
      'message', 'Referral code not found'
    );
  END IF;
  
  RETURN json_build_object(
    'success', true,
    'wallet_address', wallet_address
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fix_staking_balances                        | 
DECLARE
    fixed_count INTEGER := 0;
    wallet_record RECORD;
BEGIN
    -- Fix all user balances based on current staking data
    FOR wallet_record IN 
        SELECT DISTINCT wallet_address FROM staked_tokens
        UNION
        SELECT DISTINCT wallet_address FROM user_balances
    LOOP
        -- Trigger balance sync for each wallet
        PERFORM sync_staking_balance() WHERE NEW.wallet_address = wallet_record.wallet_address;
        fixed_count := fixed_count + 1;
    END LOOP;
    
    RETURN json_build_object(
        'success', true,
        'fixed_wallets', fixed_count,
        'message', format('Fixed balances for %s wallets', fixed_count)
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| force_generate_user_rewards                 | 
DECLARE
    nft_record RECORD;
    token_record RECORD;
    total_reward DECIMAL(18,8);
    total_generated INTEGER := 0;
    current_date DATE := CURRENT_DATE;
BEGIN
    -- Force generate rewards for user's staked NFTs (ignores time constraints)
    FOR nft_record IN
        SELECT 
            id,
            wallet_address,
            nft_id,
            daily_reward,
            staked_at
        FROM staked_nfts
        WHERE wallet_address = user_wallet
    LOOP
        -- Always generate at least 1 day of rewards for testing
        total_reward := nft_record.daily_reward * 1;
        
        -- Insert reward record (FIXED: Use UUID directly)
        INSERT INTO staking_rewards (
            wallet_address,
            reward_type,
            source_id,
            reward_amount,
            reward_date,
            is_claimed
        ) VALUES (
            nft_record.wallet_address,
            'nft_staking',
            nft_record.id, -- Already UUID, no casting needed
            total_reward,
            current_date,
            false
        );
        
        -- Update last reward calculated
        UPDATE staked_nfts 
        SET last_reward_calculated = current_date
        WHERE id = nft_record.id;
        
        total_generated := total_generated + 1;
    END LOOP;
    
    -- Force generate rewards for user's staked tokens
    FOR token_record IN
        SELECT 
            id,
            wallet_address,
            amount,
            daily_reward,
            staked_at
        FROM staked_tokens
        WHERE wallet_address = user_wallet
    LOOP
        -- Always generate at least 1 day of rewards for testing
        total_reward := token_record.daily_reward * 1;
        
        -- Insert reward record (FIXED: Use UUID directly)
        INSERT INTO staking_rewards (
            wallet_address,
            reward_type,
            source_id,
            reward_amount,
            reward_date,
            is_claimed
        ) VALUES (
            token_record.wallet_address,
            'token_staking',
            token_record.id, -- Already UUID, no casting needed
            total_reward,
            current_date,
            false
        );
        
        -- Update last reward calculated
        UPDATE staked_tokens 
        SET last_reward_calculated = current_date
        WHERE id = token_record.id;
        
        total_generated := total_generated + 1;
    END LOOP;
    
    RETURN json_build_object(
        'success', true,
        'message', format('Force generated %s daily rewards for user %s', total_generated, user_wallet),
        'rewards_generated', total_generated,
        'generation_date', current_date,
        'wallet_address', user_wallet
    );

EXCEPTION
    WHEN OTHERS THEN
        RETURN json_build_object(
            'success', false,
            'error', SQLERRM,
            'message', format('Error force generating rewards for user %s: %s', user_wallet, SQLERRM)
        );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| generate_all_users_daily_rewards            | 
DECLARE
    user_record RECORD;
    result_record RECORD;
    total_users_processed INTEGER := 0;
    total_rewards_generated INTEGER := 0;
    failed_users TEXT[] := '{}';
    success_users TEXT[] := '{}';
    current_date DATE := CURRENT_DATE;
BEGIN
    -- Get all users who have staked assets (NFTs or tokens)
    FOR user_record IN
        SELECT DISTINCT wallet_address
        FROM (
            SELECT wallet_address FROM staked_nfts WHERE is_active = true
            UNION
            SELECT wallet_address FROM staked_tokens WHERE is_active = true
        ) AS all_stakers
    LOOP
        BEGIN
            -- Generate rewards for this user
            SELECT * INTO result_record 
            FROM generate_user_daily_rewards(user_record.wallet_address);
            
            -- Parse the result
            IF (result_record.generate_user_daily_rewards->>'success')::boolean = true THEN
                total_users_processed := total_users_processed + 1;
                total_rewards_generated := total_rewards_generated + 
                    COALESCE((result_record.generate_user_daily_rewards->>'rewards_generated')::integer, 0);
                success_users := array_append(success_users, user_record.wallet_address);
            ELSE
                failed_users := array_append(failed_users, user_record.wallet_address);
            END IF;
            
        EXCEPTION WHEN OTHERS THEN
            -- Log the error and continue with next user
            failed_users := array_append(failed_users, user_record.wallet_address);
            RAISE NOTICE 'Error generating rewards for user %: %', user_record.wallet_address, SQLERRM;
        END;
    END LOOP;

    -- Return comprehensive results
    RETURN json_build_object(
        'success', true,
        'message', 'Bulk reward generation completed',
        'total_users_processed', total_users_processed,
        'total_rewards_generated', total_rewards_generated,
        'successful_users', array_length(success_users, 1),
        'failed_users', array_length(failed_users, 1),
        'failed_user_list', failed_users,
        'generation_date', current_date,
        'timestamp', NOW()
    );

EXCEPTION WHEN OTHERS THEN
    RETURN json_build_object(
        'success', false,
        'error', SQLERRM,
        'message', 'Failed to generate rewards for all users'
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| generate_daily_rewards                      | 
DECLARE
    nft_record RECORD;
    token_record RECORD;
    days_staked INTEGER;
    total_reward DECIMAL(18,8);
    total_generated INTEGER := 0;
    current_date DATE := CURRENT_DATE;
    last_calc_date DATE;
BEGIN
    -- Generate rewards for staked NFTs
    FOR nft_record IN
        SELECT 
            id,
            wallet_address,
            nft_id,
            daily_reward,
            staked_at,
            last_reward_calculated
        FROM staked_nfts
    LOOP
        -- Get the last calculation date, default to staked_at if null
        last_calc_date := COALESCE(nft_record.last_reward_calculated::date, nft_record.staked_at::date);
        
        -- Calculate days since last reward calculation using proper date arithmetic
        days_staked := current_date - last_calc_date;
        
        IF days_staked > 0 THEN
            -- Calculate total reward for the period
            total_reward := nft_record.daily_reward * days_staked;
            
            -- Insert reward record
            INSERT INTO staking_rewards (
                wallet_address,
                reward_type,
                source_id,
                reward_amount,
                reward_date,
                is_claimed
            ) VALUES (
                nft_record.wallet_address,
                'nft_staking',
                nft_record.id::text,
                total_reward,
                current_date,
                false
            );
            
            -- Update last reward calculated
            UPDATE staked_nfts 
            SET last_reward_calculated = current_date
            WHERE id = nft_record.id;
            
            total_generated := total_generated + 1;
        END IF;
    END LOOP;
    
    -- Generate rewards for staked tokens
    FOR token_record IN
        SELECT 
            id,
            wallet_address,
            amount,
            daily_reward,
            staked_at,
            last_reward_calculated
        FROM staked_tokens
    LOOP
        -- Get the last calculation date, default to staked_at if null
        last_calc_date := COALESCE(token_record.last_reward_calculated::date, token_record.staked_at::date);
        
        -- Calculate days since last reward calculation using proper date arithmetic
        days_staked := current_date - last_calc_date;
        
        IF days_staked > 0 THEN
            -- Calculate total reward for the period
            total_reward := token_record.daily_reward * days_staked;
            
            -- Insert reward record
            INSERT INTO staking_rewards (
                wallet_address,
                reward_type,
                source_id,
                reward_amount,
                reward_date,
                is_claimed
            ) VALUES (
                token_record.wallet_address,
                'token_staking',
                token_record.id::text,
                total_reward,
                current_date,
                false
            );
            
            -- Update last reward calculated
            UPDATE staked_tokens 
            SET last_reward_calculated = current_date
            WHERE id = token_record.id;
            
            total_generated := total_generated + 1;
        END IF;
    END LOOP;
    
    RETURN json_build_object(
        'success', true,
        'message', format('Generated %s daily rewards', total_generated),
        'rewards_generated', total_generated,
        'generation_date', current_date
    );

EXCEPTION
    WHEN OTHERS THEN
        RETURN json_build_object(
            'success', false,
            'error', SQLERRM
        );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| generate_daily_staking_rewards              | 
DECLARE
    reward_date DATE := CURRENT_DATE;
    processed_count INTEGER := 0;
    wallet_record RECORD;
    cutoff_time TIMESTAMP WITH TIME ZONE;
BEGIN
    -- Calculate 24-hour cutoff time
    cutoff_time := NOW() - INTERVAL '24 hours';
    
    -- Process rewards for each wallet with staked assets (staked for 24+ hours)
    FOR wallet_record IN (
        SELECT DISTINCT wallet_address
        FROM (
            SELECT wallet_address FROM staked_nfts WHERE staked_at <= cutoff_time
            UNION
            SELECT wallet_address FROM staked_tokens WHERE staked_at <= cutoff_time
        ) AS eligible_wallets
    ) LOOP
        -- Insert or update daily rewards
        INSERT INTO staking_rewards (
            wallet_address,
            reward_date,
            nft_rewards,
            token_rewards,
            total_rewards
        )
        SELECT
            wallet_record.wallet_address,
            reward_date,
            COALESCE(nft_rewards.total, 0),
            COALESCE(token_rewards.total, 0),
            COALESCE(nft_rewards.total, 0) + COALESCE(token_rewards.total, 0)
        FROM (
            SELECT COALESCE(SUM(daily_reward), 0) as total
            FROM staked_nfts
            WHERE wallet_address = wallet_record.wallet_address
            AND staked_at <= cutoff_time
        ) nft_rewards
        CROSS JOIN (
            SELECT COALESCE(SUM(daily_reward), 0) as total
            FROM staked_tokens
            WHERE wallet_address = wallet_record.wallet_address
            AND staked_at <= cutoff_time
        ) token_rewards
        WHERE (COALESCE(nft_rewards.total, 0) + COALESCE(token_rewards.total, 0)) > 0
        ON CONFLICT (wallet_address, reward_date)
        DO UPDATE SET
            nft_rewards = EXCLUDED.nft_rewards,
            token_rewards = EXCLUDED.token_rewards,
            total_rewards = EXCLUDED.total_rewards;
        
        processed_count := processed_count + 1;
    END LOOP;
    
    RETURN processed_count;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| generate_referral_code                      | 
BEGIN
  IF NEW.referral_code IS NULL THEN
    NEW.referral_code := 'NEFT-' || upper(substring(md5(random()::text) from 1 for 6));
  END IF;
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| get_achievement_stats                       | 
BEGIN
  -- Initialize user achievements if needed
  PERFORM initialize_user_achievements(user_wallet);
  
  RETURN QUERY
  WITH stats AS (
    SELECT 
      COUNT(*)::INTEGER as total_achievements,
      COUNT(CASE WHEN ua.status = 'completed'::achievement_status THEN 1 END)::INTEGER as completed_achievements,
      COUNT(CASE WHEN ua.status = 'in_progress'::achievement_status THEN 1 END)::INTEGER as in_progress_achievements
    FROM achievements_master am
    LEFT JOIN user_achievements ua ON am.achievement_key = ua.achievement_key 
      AND ua.wallet_address = user_wallet
    WHERE am.is_active = TRUE
  )
  SELECT 
    total_achievements,
    completed_achievements,
    in_progress_achievements,
    CASE 
      WHEN total_achievements > 0 THEN ROUND((completed_achievements::DECIMAL / total_achievements::DECIMAL) * 100)::INTEGER
      ELSE 0
    END as completion_percentage
  FROM stats;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| get_all_milestones_cached                   | 
BEGIN
  RETURN (
    SELECT COALESCE(
      json_agg(
        json_build_object(
          'day', milestone_day,
          'name', milestone_name,
          'description', milestone_description,
          'reward', 
            CASE 
              WHEN nft_reward IS NOT NULL 
              THEN (nft_reward->>'type') || ' NFT + ' || (base_neft_reward + bonus_neft_reward) || ' NEFT + ' || (base_xp_reward + bonus_xp_reward) || ' XP'
              ELSE (base_neft_reward + bonus_neft_reward) || ' NEFT + ' || (base_xp_reward + bonus_xp_reward) || ' XP'
            END,
          'icon', COALESCE(icon_name, 'Gift'),
          'color', COALESCE(color_scheme, 'from-blue-600 to-blue-400'),
          'isSpecial', is_special_milestone,
          'total_neft_reward', base_neft_reward + bonus_neft_reward,
          'total_xp_reward', base_xp_reward + bonus_xp_reward,
          'nft_reward', nft_reward
        )
        ORDER BY milestone_day ASC
      ), '[]'::json
    )::JSONB
    FROM daily_claim_milestones
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| get_daily_claim_dashboard                   | 
DECLARE
  user_record RECORD;
  reward_data RECORD;
  can_claim BOOLEAN := FALSE;
  next_streak_calc INTEGER;
  milestones_json JSONB;
  claims_json JSONB;
  hours_until INTEGER := 0;
  minutes_until INTEGER := 0;
BEGIN
  -- Get user streak record
  SELECT * INTO user_record FROM user_streaks WHERE wallet_address = user_wallet;
  
  -- Check if user can claim today
  can_claim := NOT EXISTS (
    SELECT 1 FROM daily_claims 
    WHERE wallet_address = user_wallet 
    AND claim_date = CURRENT_DATE
  );
  
  -- Calculate next streak
  IF user_record IS NULL THEN
    next_streak_calc := 1;
  ELSE
    IF can_claim THEN
      IF user_record.last_claim_date = CURRENT_DATE - INTERVAL '1 day' THEN
        next_streak_calc := user_record.current_streak + 1;
      ELSE
        next_streak_calc := 1;
      END IF;
    ELSE
      next_streak_calc := user_record.current_streak;
    END IF;
  END IF;
  
  -- Get next reward calculation (with fallback if calculate_daily_reward doesn't exist)
  BEGIN
    SELECT * INTO reward_data FROM calculate_daily_reward(next_streak_calc, user_wallet);
  EXCEPTION WHEN OTHERS THEN
    -- Fallback reward calculation with correct column names
    SELECT 
      CASE 
        WHEN next_streak_calc >= 30 THEN 50.0
        WHEN next_streak_calc >= 14 THEN 30.0
        WHEN next_streak_calc >= 7 THEN 20.0
        WHEN next_streak_calc >= 3 THEN 15.0
        ELSE 10.0
      END as base_neft,
      0.0 as bonus_neft,
      CASE 
        WHEN next_streak_calc >= 30 THEN 100
        WHEN next_streak_calc >= 14 THEN 50
        WHEN next_streak_calc >= 7 THEN 30
        WHEN next_streak_calc >= 3 THEN 15
        ELSE 5
      END as base_xp,
      0 as bonus_xp,
      NULL::JSONB as nft_reward,
      CASE 
        WHEN next_streak_calc >= 30 THEN 'Legendary'
        WHEN next_streak_calc >= 14 THEN 'Epic'
        WHEN next_streak_calc >= 7 THEN 'Rare'
        WHEN next_streak_calc >= 3 THEN 'Uncommon'
        ELSE 'Common'
      END as reward_tier,
      CASE WHEN next_streak_calc IN (7, 14, 30) THEN TRUE ELSE FALSE END as is_milestone
    INTO reward_data;
  END;
  
  -- Get upcoming milestones (with fallback if table doesn't exist)
  BEGIN
    SELECT COALESCE(
      json_agg(
        json_build_object(
          'milestone_day', milestone_day,
          'milestone_name', milestone_name,
          'milestone_description', milestone_description,
          'total_neft_reward', base_neft_reward + bonus_neft_reward,
          'total_xp_reward', base_xp_reward + bonus_xp_reward,
          'nft_reward', nft_reward,
          'is_special_milestone', is_special_milestone,
          'icon_name', icon_name,
          'color_scheme', color_scheme
        ) ORDER BY milestone_day ASC
      ), '[]'::json
    )::JSONB INTO milestones_json
    FROM (
      SELECT milestone_day, milestone_name, milestone_description, 
             base_neft_reward, bonus_neft_reward, base_xp_reward, bonus_xp_reward,
             nft_reward, is_special_milestone, icon_name, color_scheme
      FROM daily_claim_milestones 
      WHERE milestone_day > COALESCE(user_record.current_streak, 0)
      ORDER BY milestone_day ASC 
      LIMIT 5
    ) milestone_data;
  EXCEPTION WHEN OTHERS THEN
    -- Fallback milestones
    milestones_json := '[
      {"milestone_day": 7, "milestone_name": "Weekly Champion", "milestone_description": "A full week of engagement!", "total_neft_reward": 50, "total_xp_reward": 30, "is_special_milestone": true},
      {"milestone_day": 14, "milestone_name": "Fortnight Milestone", "milestone_description": "Two weeks of dedication", "total_neft_reward": 100, "total_xp_reward": 50, "is_special_milestone": true},
      {"milestone_day": 30, "milestone_name": "Monthly Master", "milestone_description": "A month of consistent engagement!", "total_neft_reward": 200, "total_xp_reward": 100, "is_special_milestone": true}
    ]'::JSONB;
  END;
  
  -- Get recent claims history (with fallback if table access fails)
  BEGIN
    SELECT COALESCE(
      json_agg(
        json_build_object(
          'claim_date', claim_date,
          'streak_count', streak_count,
          'total_neft_reward', base_neft_reward + bonus_neft_reward,
          'total_xp_reward', base_xp_reward + bonus_xp_reward,
          'reward_tier', reward_tier,
          'nft_reward', nft_reward,
          'claimed_at', claimed_at
        )
        ORDER BY claim_date DESC
      ), '[]'::json
    )::JSONB INTO claims_json
    FROM daily_claims 
    WHERE wallet_address = user_wallet
    ORDER BY claim_date DESC 
    LIMIT 10;
  EXCEPTION WHEN OTHERS THEN
    claims_json := '[]'::JSONB;
  END;
  
  -- Calculate time until next claim (if already claimed today)
  IF NOT can_claim AND user_record.last_claim_date IS NOT NULL THEN
    SELECT 
      EXTRACT(HOUR FROM (DATE_TRUNC('day', NOW()) + INTERVAL '1 day' - NOW())),
      EXTRACT(MINUTE FROM (DATE_TRUNC('day', NOW()) + INTERVAL '1 day' - NOW()))
    INTO hours_until, minutes_until;
  END IF;
  
  -- Return comprehensive dashboard data
  RETURN QUERY SELECT 
    COALESCE(user_record.current_streak, 0),
    COALESCE(user_record.longest_streak, 0),
    COALESCE(user_record.total_claims, 0),
    can_claim,
    user_record.last_claim_date,
    COALESCE(user_record.total_neft_earned, 0.0),
    COALESCE(user_record.total_xp_earned, 0),
    user_record.streak_started_at,
    next_streak_calc,
    COALESCE((reward_data).base_neft + (reward_data).bonus_neft, 10.0),
    COALESCE((reward_data).base_xp + (reward_data).bonus_xp, 5),
    COALESCE((reward_data).reward_tier, 'Common'),
    COALESCE((reward_data).is_milestone, FALSE),
    milestones_json,
    claims_json,
    hours_until::INTEGER,
    minutes_until::INTEGER;
END;
 |
| get_direct_user_balance                     | 
DECLARE
    total_neft_claimed DECIMAL(18,8) := 0;
    total_xp_earned INTEGER := 0;
    referral_neft DECIMAL(18,8) := 0;
    staked_amount DECIMAL(18,8) := 0;
    last_updated TIMESTAMPTZ := NOW();
BEGIN
    -- Get user balance data
    SELECT 
        COALESCE(ub.total_neft_claimed, 0),
        COALESCE(ub.total_xp_earned, 0),
        COALESCE(ub.last_updated, NOW())
    INTO total_neft_claimed, total_xp_earned, last_updated
    FROM user_balances ub
    WHERE ub.wallet_address = user_wallet;
    
    -- Get referral earnings
    SELECT COALESCE(ur.total_neft_earned, 0)
    INTO referral_neft
    FROM user_referrals ur
    WHERE ur.wallet_address = user_wallet;
    
    -- Get staked amount
    SELECT COALESCE(SUM(st.amount), 0)
    INTO staked_amount
    FROM staked_tokens st
    WHERE st.wallet_address = user_wallet;
    
    -- Return JSON with correct available_neft calculation
    RETURN json_build_object(
        'total_neft_claimed', total_neft_claimed + referral_neft,
        'total_xp_earned', total_xp_earned,
        'available_neft', GREATEST(0, (total_neft_claimed + referral_neft) - staked_amount),
        'staked_neft', staked_amount,
        'total_nft_count', 0,
        'last_updated', last_updated
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| get_milestone_info                          | 
BEGIN
  RETURN QUERY
  SELECT 
    m.milestone_name,
    m.milestone_description,
    m.base_neft_reward + m.bonus_neft_reward,
    m.base_xp_reward + m.bonus_xp_reward,
    m.nft_reward,
    m.is_special_milestone
  FROM daily_claim_milestones m
  WHERE m.milestone_day = milestone_day;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| get_nft_stats                               | 
BEGIN
    RETURN QUERY
    SELECT 
        n.rarity,
        COUNT(*) as count,
        SUM(n.burn_value) as total_burn_value
    FROM nfts n
    WHERE n.owner_wallet = wallet_addr 
    AND n.claimed = false
    GROUP BY n.rarity
    ORDER BY 
        CASE n.rarity
            WHEN 'Common' THEN 1
            WHEN 'Rare' THEN 2
            WHEN 'Legendary' THEN 3
            WHEN 'Platinum' THEN 4
            WHEN 'Silver' THEN 5
            WHEN 'Gold' THEN 6
            ELSE 7
        END;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| get_or_create_referral_profile              | 
DECLARE
  v_code TEXT;
BEGIN
  -- Try to get existing profile
  SELECT ur.referral_code, ur.total_referrals, ur.total_neft_earned
  INTO referral_code, total_referrals, total_neft_earned
  FROM public.user_referrals ur
  WHERE ur.wallet_address = p_wallet_address;

  -- Create if doesn't exist
  IF NOT FOUND THEN
    v_code := 'NEFT-' || UPPER(SUBSTRING(MD5(gen_random_uuid()::TEXT) FROM 1 FOR 8));
    
    INSERT INTO public.user_referrals (wallet_address, referral_code, total_referrals, total_neft_earned)
    VALUES (p_wallet_address, v_code, 0, 0)
    RETURNING user_referrals.referral_code, user_referrals.total_referrals, user_referrals.total_neft_earned
    INTO referral_code, total_referrals, total_neft_earned;
  END IF;

  RETURN NEXT;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| get_project_details                         | 
DECLARE
    result JSON;
    project_data JSON;
    tasks_data JSON;
    user_participation_data JSON;
    user_completions_data JSON;
BEGIN
    SELECT json_build_object(
        'id', p.id,
        'title', p.title,
        'description', p.description,
        'collection_name', p.collection_name,
        'image_url', p.image_url,
        'banner_url', p.banner_url,
        'reward_amount', p.reward_amount,
        'reward_currency', p.reward_currency,
        'xp_reward', p.xp_reward,
        'max_participants', p.max_participants,
        'current_participants', p.current_participants,
        'category', p.category,
        'subcategory', p.subcategory,
        'blockchain', p.blockchain,
        'network', p.network,
        'start_date', p.start_date,
        'end_date', p.end_date,
        'is_active', p.is_active,
        'is_featured', p.is_featured,
        'is_offchain', p.is_offchain,
        'total_supply', p.total_supply,
        'level_requirement', p.level_requirement,
        'usd_value', p.usd_value,
        'target_chain', p.target_chain,
        'claim_status', p.claim_status,
        'task_status', p.task_status,
        'website', p.website,
        'twitter', p.twitter,
        'discord', p.discord,
        'owner', p.owner,
        'rarity_distribution', p.rarity_distribution,
        'metadata', p.metadata,
        'status', CASE 
            WHEN p.end_date < NOW() THEN 'ended'
            WHEN p.start_date > NOW() THEN 'upcoming'
            ELSE 'active'
        END,
        'seconds_remaining', CASE 
            WHEN p.end_date > NOW() THEN EXTRACT(EPOCH FROM (p.end_date - NOW()))
            ELSE 0
        END
    ) INTO project_data
    FROM projects p
    WHERE p.id = p_project_id AND p.is_active = true;
    
    IF project_data IS NULL THEN
        RETURN json_build_object('error', 'Project not found');
    END IF;
    
    SELECT COALESCE(json_agg(
        json_build_object(
            'id', pt.id,
            'title', pt.title,
            'description', pt.description,
            'type', pt.type,
            'action_url', pt.action_url,
            'discord_user_id', pt.discord_user_id,
            'discord_guild_id', pt.discord_guild_id,
            'required_role_id', pt.required_role_id,
            'telegram_channel_id', pt.telegram_channel_id,
            'website_url', pt.website_url,
            'quiz_questions', pt.quiz_questions,
            'quiz_passing_score', pt.quiz_passing_score,
            'twitter_username', pt.twitter_username,
            'twitter_tweet_id', pt.twitter_tweet_id,
            'is_active', pt.is_active,
            'sort_order', pt.sort_order
        ) ORDER BY pt.sort_order, pt.created_at
    ), '[]'::json) INTO tasks_data
    FROM project_tasks pt
    WHERE pt.project_id = p_project_id AND pt.is_active = true;
    
    IF p_wallet_address IS NOT NULL THEN
        SELECT json_build_object(
            'joined_at', up.joined_at,
            'completed_tasks_count', up.completed_tasks_count,
            'total_tasks_count', up.total_tasks_count,
            'completion_percentage', up.completion_percentage,
            'rewards_claimed', up.rewards_claimed,
            'claimed_at', up.claimed_at
        ) INTO user_participation_data
        FROM user_participations up
        WHERE up.project_id = p_project_id AND up.wallet_address = p_wallet_address;
        
        SELECT COALESCE(json_object_agg(
            utc.task_id::text, 
            json_build_object(
                'completed', utc.completed,
                'completed_at', utc.completed_at,
                'verification_data', utc.verification_data
            )
        ), '{}'::json) INTO user_completions_data
        FROM user_task_completions utc
        WHERE utc.wallet_address = p_wallet_address AND utc.project_id = p_project_id;
    END IF;
    
    SELECT json_build_object(
        'project', project_data,
        'tasks', tasks_data,
        'user_participation', user_participation_data,
        'user_completions', COALESCE(user_completions_data, '{}'::json)
    ) INTO result;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| get_project_tasks_with_completion           | 
DECLARE
  result JSON;
  tasks_data JSON;
  user_completions JSON;
BEGIN
  -- Get project tasks
  SELECT COALESCE(json_agg(
    json_build_object(
      'id', pt.id,
      'title', pt.title,
      'description', pt.description,
      'type', pt.type,
      'action_url', pt.action_url,
      'discord_user_id', pt.discord_user_id,
      'discord_guild_id', pt.discord_guild_id,
      'required_role_id', pt.required_role_id,
      'is_active', pt.is_active,
      'sort_order', pt.sort_order
    ) ORDER BY pt.sort_order, pt.created_at
  ), '[]'::json) INTO tasks_data
  FROM project_tasks pt
  WHERE pt.project_id = p_project_id AND pt.is_active = true;
  
  -- Get user completions if wallet provided
  IF p_wallet_address IS NOT NULL THEN
    SELECT COALESCE(json_object_agg(
      utc.task_id::text, 
      json_build_object(
        'completed', utc.completed,
        'completed_at', utc.completed_at,
        'verification_data', utc.verification_data
      )
    ), '{}'::json) INTO user_completions
    FROM user_task_completions utc
    WHERE utc.project_id = p_project_id AND utc.wallet_address = p_wallet_address;
  ELSE
    user_completions := '{}'::json;
  END IF;
  
  -- Build final result
  SELECT json_build_object(
    'tasks', tasks_data,
    'user_completions', user_completions
  ) INTO result;
  
  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| get_projects_dashboard                      | 
DECLARE
    result JSON;
    total_count INTEGER;
    active_count INTEGER;
    featured_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO total_count FROM projects WHERE is_active = true;
    SELECT COUNT(*) INTO active_count FROM projects WHERE is_active = true;
    SELECT COUNT(*) INTO featured_count FROM projects WHERE is_active = true AND is_featured = true;
    
    WITH filtered_projects AS (
        SELECT 
            p.*,
            CASE 
                WHEN p.end_date < NOW() THEN 'ended'
                WHEN p.start_date > NOW() THEN 'upcoming'
                ELSE 'active'
            END as status,
            CASE 
                WHEN p.end_date > NOW() THEN EXTRACT(EPOCH FROM (p.end_date - NOW()))
                ELSE 0
            END as seconds_remaining
        FROM projects p
        WHERE p.is_active = true
            AND (p_category = 'all' OR p.category = p_category OR (p_category = 'featured' AND p.is_featured = true))
            AND (p_search_query = '' OR 
                 p.title ILIKE '%' || p_search_query || '%' OR 
                 p.collection_name ILIKE '%' || p_search_query || '%')
        ORDER BY 
            p.is_featured DESC,
            p.end_date ASC NULLS LAST,
            p.created_at DESC
        LIMIT p_limit OFFSET p_offset
    )
    SELECT json_build_object(
        'projects', COALESCE(json_agg(
            json_build_object(
                'id', fp.id,
                'title', fp.title,
                'description', fp.description,
                'collection_name', fp.collection_name,
                'image_url', fp.image_url,
                'banner_url', fp.banner_url,
                'reward_amount', fp.reward_amount,
                'reward_currency', fp.reward_currency,
                'xp_reward', fp.xp_reward,
                'max_participants', fp.max_participants,
                'current_participants', fp.current_participants,
                'category', fp.category,
                'blockchain', fp.blockchain,
                'start_date', fp.start_date,
                'end_date', fp.end_date,
                'is_active', fp.is_active,
                'is_featured', fp.is_featured,
                'status', fp.status,
                'seconds_remaining', fp.seconds_remaining,
                'website', fp.website,
                'twitter', fp.twitter,
                'discord', fp.discord,
                'rarity_distribution', fp.rarity_distribution,
                'metadata', fp.metadata
            )
        ), '[]'::json),
        'stats', json_build_object(
            'total_projects', total_count,
            'active_projects', active_count,
            'featured_projects', featured_count
        ),
        'pagination', json_build_object(
            'limit', p_limit,
            'offset', p_offset,
            'has_more', (SELECT COUNT(*) FROM filtered_projects) = p_limit
        )
    ) INTO result
    FROM filtered_projects fp;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| get_quest_progress                          | 
DECLARE
  result JSON;
  completed_tasks INTEGER;
  total_chances INTEGER;
  used_chances INTEGER;
  available_chances INTEGER;
BEGIN
  -- Count completed tasks
  SELECT COUNT(*) INTO completed_tasks
  FROM user_task_completions
  WHERE wallet_address = p_wallet_address 
    AND completed = true;
  
  -- Count burn chances
  SELECT COUNT(*) INTO total_chances
  FROM user_burn_chances
  WHERE wallet_address = p_wallet_address;
  
  SELECT COUNT(*) INTO used_chances
  FROM user_burn_chances
  WHERE wallet_address = p_wallet_address 
    AND used_at IS NOT NULL;
  
  available_chances := total_chances - used_chances;
  
  result := json_build_object(
    'completedTasks', completed_tasks,
    'totalTasksRequired', 2,
    'burnChancesAvailable', available_chances,
    'burnChancesUsed', used_chances,
    'isQuestComplete', available_chances > 0,
    'progressPercentage', CASE 
      WHEN available_chances > 0 THEN 100
      ELSE (completed_tasks % 2) * 50
    END
  );
  
  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| get_referral_leaderboard                    | 
  SELECT 
    ur.wallet_address,
    ur.total_referrals,
    ur.total_neft_earned,
    ROW_NUMBER() OVER (ORDER BY ur.total_referrals DESC, ur.total_neft_earned DESC) as rank
  FROM public.user_referrals ur
  WHERE ur.total_referrals > 0
  ORDER BY ur.total_referrals DESC, ur.total_neft_earned DESC
  LIMIT p_limit;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| get_referral_stats                          | 
DECLARE
  result JSON;
BEGIN
  SELECT json_build_object(
    'total_referrals', COALESCE(rs.total_referrals, 0),
    'total_neft_earned', COALESCE(rs.total_neft_earned, 0),
    'total_xp_earned', COALESCE(rs.total_xp_earned, 0),
    'current_tier', COALESCE(rs.current_tier, 0),
    'last_tier_claimed', COALESCE(rs.last_tier_claimed, 0)
  ) INTO result
  FROM referral_stats rs
  WHERE rs.wallet_address = user_wallet;
  
  -- Return default stats if user not found
  IF result IS NULL THEN
    result := json_build_object(
      'total_referrals', 0,
      'total_neft_earned', 0,
      'total_xp_earned', 0,
      'current_tier', 0,
      'last_tier_claimed', 0
    );
  END IF;
  
  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| get_reward_generation_stats                 | 
DECLARE
    stats_record RECORD;
    total_pending_rewards DECIMAL(18,8);
    total_claimed_rewards DECIMAL(18,8);
    active_stakers INTEGER;
BEGIN
    -- Get basic statistics
    SELECT 
        COUNT(*) as total_rewards,
        SUM(CASE WHEN is_claimed = false THEN reward_amount ELSE 0 END) as pending_amount,
        SUM(CASE WHEN is_claimed = true THEN reward_amount ELSE 0 END) as claimed_amount,
        COUNT(DISTINCT user_wallet) as unique_users
    INTO stats_record
    FROM staking_rewards;
    
    -- Get active stakers count
    SELECT COUNT(DISTINCT wallet_address) INTO active_stakers
    FROM (
        SELECT wallet_address FROM staked_nfts WHERE is_active = true
        UNION
        SELECT wallet_address FROM staked_tokens WHERE is_active = true
    ) AS all_stakers;
    
    RETURN json_build_object(
        'success', true,
        'total_rewards_records', COALESCE(stats_record.total_rewards, 0),
        'pending_rewards_amount', COALESCE(stats_record.pending_amount, 0),
        'claimed_rewards_amount', COALESCE(stats_record.claimed_amount, 0),
        'unique_users_with_rewards', COALESCE(stats_record.unique_users, 0),
        'active_stakers', COALESCE(active_stakers, 0),
        'last_updated', NOW()
    );

EXCEPTION WHEN OTHERS THEN
    RETURN json_build_object(
        'success', false,
        'error', SQLERRM,
        'message', 'Failed to get reward generation statistics'
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| get_staked_nfts                             | 
DECLARE
    result JSON;
BEGIN
    SELECT COALESCE(json_agg(
        json_build_object(
            'id', id,
            'wallet_address', wallet_address,
            'nft_id', nft_id,
            'nft_rarity', nft_rarity,
            'daily_reward', daily_reward,
            'staked_at', staked_at
        ) ORDER BY staked_at DESC
    ), '[]'::json) INTO result
    FROM staked_nfts
    WHERE wallet_address = user_wallet;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| get_staked_tokens                           | 
DECLARE
    result JSON;
BEGIN
    SELECT COALESCE(json_agg(
        json_build_object(
            'id', id,
            'wallet_address', wallet_address,
            'amount', amount,
            'apr_rate', apr_rate,
            'daily_reward', daily_reward,
            'staked_at', staked_at
        ) ORDER BY staked_at DESC
    ), '[]'::json) INTO result
    FROM staked_tokens
    WHERE wallet_address = user_wallet;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| get_table_columns                           | 
  select column_name, data_type
  from information_schema.columns
  where table_name = $1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| get_top_neft_holders                        | 
BEGIN
  RETURN QUERY
  SELECT 
    ub.wallet_address,
    (COALESCE(ub.total_neft_claimed, 0) + COALESCE(ur.total_neft_earned, 0)) as total_neft_claimed,
    ROW_NUMBER() OVER (ORDER BY (COALESCE(ub.total_neft_claimed, 0) + COALESCE(ur.total_neft_earned, 0)) DESC)::INTEGER as rank_position
  FROM user_balances ub
  LEFT JOIN user_referrals ur ON ur.wallet_address = ub.wallet_address
  WHERE (COALESCE(ub.total_neft_claimed, 0) + COALESCE(ur.total_neft_earned, 0)) > 0
  ORDER BY (COALESCE(ub.total_neft_claimed, 0) + COALESCE(ur.total_neft_earned, 0)) DESC
  LIMIT result_limit;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| get_top_nft_holders                         | 
BEGIN
  RETURN QUERY
  WITH nft_counts AS (
    SELECT 
      nc.wallet_address,
      COUNT(*)::INTEGER as nft_count
    FROM nft_collections nc
    WHERE nc.is_active = true  -- Only count active (non-burned) NFTs
    GROUP BY nc.wallet_address
  )
  SELECT 
    nfc.wallet_address,
    nfc.nft_count,
    ROW_NUMBER() OVER (ORDER BY nfc.nft_count DESC)::INTEGER as rank_position
  FROM nft_counts nfc
  WHERE nfc.nft_count > 0
  ORDER BY nfc.nft_count DESC
  LIMIT result_limit;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| get_user_achievements                       | 
BEGIN
  RETURN QUERY
  SELECT 
    am.achievement_key,
    am.title,
    am.description,
    am.category,
    am.icon,
    am.color,
    am.neft_reward,
    am.xp_reward,
    am.nft_reward,
    am.required_count,
    COALESCE(ua.current_progress, 0) as current_progress,
    COALESCE(ua.status, 'locked'::achievement_status) as status,
    ua.completed_at,
    ua.claimed_at,
    CASE 
      WHEN COALESCE(ua.current_progress, 0) >= am.required_count THEN 100
      WHEN am.required_count > 0 THEN ROUND((COALESCE(ua.current_progress, 0)::DECIMAL / am.required_count::DECIMAL) * 100)
      ELSE 0
    END::INTEGER as progress_percentage
  FROM achievements_master am
  LEFT JOIN user_achievements ua ON am.achievement_key = ua.achievement_key 
    AND ua.wallet_address = user_wallet
  WHERE am.is_active = TRUE
    AND (category_filter IS NULL OR am.category = category_filter)
  ORDER BY 
    am.sort_order ASC,
    am.category ASC,
    am.achievement_key ASC;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| get_user_activities                         | 
BEGIN
  RETURN QUERY
  SELECT 
    ua.id,
    ua.activity_type as type,
    ua.activity_title,
    ua.activity_description,
    ua.details,
    ua.neft_reward,
    ua.xp_reward,
    ua.nft_reward,
    ua.status,
    ua.metadata,
    ua.created_at
  FROM user_activities ua
  WHERE ua.wallet_address = user_wallet
    AND (activity_type_filter IS NULL OR ua.activity_type = activity_type_filter)
  ORDER BY ua.created_at DESC
  LIMIT limit_count
  OFFSET offset_count;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| get_user_activity_statistics                | 
BEGIN
  RETURN QUERY
  SELECT 
    uas.total_activities,
    uas.total_tasks_completed,
    uas.total_claims,
    uas.total_burns,
    uas.total_stakes,
    uas.total_neft_earned,
    uas.total_xp_earned,
    uas.last_activity_at
  FROM user_activity_stats uas
  WHERE uas.wallet_address = user_wallet;
  
  -- If no stats exist, return zeros
  IF NOT FOUND THEN
    RETURN QUERY SELECT 0, 0, 0, 0, 0, 0.0::DECIMAL(18,8), 0, NULL::TIMESTAMP WITH TIME ZONE;
  END IF;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| get_user_available_balance                  | 
DECLARE
  result JSON;
  total_neft DECIMAL(18,8);
  total_xp INTEGER;
  staked_neft DECIMAL(18,8) := 0;
  available_neft DECIMAL(18,8);
  nft_count INTEGER := 0;
BEGIN
  -- Get complete balance first
  SELECT 
    (get_user_complete_balance(user_wallet)->>'total_neft')::DECIMAL(18,8),
    (get_user_complete_balance(user_wallet)->>'total_xp')::INTEGER,
    (get_user_complete_balance(user_wallet)->>'total_nft_count')::INTEGER
  INTO total_neft, total_xp, nft_count;

  -- Get staked amount from actual staked_tokens table
  SELECT COALESCE(SUM(amount), 0)
  INTO staked_neft
  FROM staked_tokens 
  WHERE wallet_address = user_wallet;

  -- Calculate available
  available_neft := GREATEST(0, total_neft - staked_neft);

  SELECT json_build_object(
    'available_neft', available_neft,
    'available_xp', total_xp,
    'staked_neft', staked_neft,
    'total_neft', total_neft,
    'total_xp', total_xp,
    'total_nft_count', nft_count
  ) INTO result;

  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| get_user_balance_breakdown                  | 
DECLARE
  result JSON;
  campaign_neft DECIMAL(18,8) := 0;
  daily_neft DECIMAL(18,8) := 0;
  achievement_neft DECIMAL(18,8) := 0;
  referral_neft DECIMAL(18,8) := 0;
  staking_neft DECIMAL(18,8) := 0;
BEGIN
  -- Campaign rewards
  SELECT COALESCE(total_neft_claimed, 0)
  INTO campaign_neft
  FROM user_balances 
  WHERE wallet_address = user_wallet;

  -- Daily claims
  SELECT COALESCE(SUM(total_neft_reward), 0)
  INTO daily_neft
  FROM daily_claims 
  WHERE wallet_address = user_wallet;

  -- Achievement rewards
  SELECT COALESCE(SUM(neft_reward), 0)
  INTO achievement_neft
  FROM user_achievements
  WHERE wallet_address = user_wallet 
    AND status = 'completed' 
    AND claimed_at IS NOT NULL;

  -- Activity rewards excluded to prevent double counting
  -- Individual services handle their own reward tracking

  -- Referral rewards (placeholder)
  referral_neft := 0;

  -- Staking rewards (placeholder for future staking rewards)
  staking_neft := 0;

  SELECT json_build_object(
    'campaign_rewards', campaign_neft,
    'daily_claims', daily_neft,
    'achievements', achievement_neft,
    'referral_rewards', referral_neft,
    'staking_rewards', staking_neft
  ) INTO result;

  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| get_user_burn_chances_summary               | 
DECLARE
  result JSON;
  total_chances INTEGER;
  used_chances INTEGER;
  available_chances INTEGER;
BEGIN
  -- Count total burn chances
  SELECT COUNT(*) INTO total_chances
  FROM user_burn_chances
  WHERE wallet_address = p_wallet_address;
  
  -- Count used burn chances
  SELECT COUNT(*) INTO used_chances
  FROM user_burn_chances
  WHERE wallet_address = p_wallet_address 
    AND used_at IS NOT NULL;
  
  -- Calculate available chances
  available_chances := total_chances - used_chances;
  
  -- Build result
  SELECT json_build_object(
    'total_chances', total_chances,
    'used_chances', used_chances,
    'available_chances', available_chances,
    'can_burn', available_chances > 0
  ) INTO result;
  
  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| get_user_claim_history                      | 
BEGIN
  RETURN QUERY
  SELECT 
    dc.claim_date,
    dc.streak_count,
    dc.total_neft_reward,
    dc.total_xp_reward,
    dc.reward_tier,
    dc.nft_reward,
    dc.claimed_at
  FROM daily_claims dc
  WHERE dc.wallet_address = user_wallet
  ORDER BY dc.claim_date DESC
  LIMIT limit_count OFFSET offset_count;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| get_user_complete_balance                   | 
DECLARE
    result JSON;
    total_neft DECIMAL(18,8) := 0;
    total_xp INTEGER := 0;
    available_neft DECIMAL(18,8) := 0;
    staked_amount DECIMAL(18,8) := 0;
BEGIN
    -- Get base balance from user_balances
    SELECT 
        COALESCE(ub.total_neft_claimed, 0),
        COALESCE(ub.total_xp_earned, 0),
        COALESCE(ub.available_neft, ub.total_neft_claimed, 0)
    INTO total_neft, total_xp, available_neft
    FROM user_balances ub
    WHERE ub.wallet_address = user_wallet;
    
    -- Get staked amount if staked_tokens table exists
    BEGIN
        SELECT COALESCE(SUM(st.amount), 0)
        INTO staked_amount
        FROM staked_tokens st
        WHERE st.wallet_address = user_wallet AND st.is_active = true;
    EXCEPTION WHEN OTHERS THEN
        staked_amount := 0;
    END;
    
    -- Calculate available NEFT (total - staked)
    available_neft := GREATEST(total_neft - staked_amount, 0);
    
    -- Build result JSON
    result := json_build_object(
        'total_neft', total_neft,
        'total_xp', total_xp,
        'available_neft', available_neft,
        'staked_neft', staked_amount,
        'wallet_address', user_wallet
    );
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| get_user_complete_balance_debug             | 
DECLARE
  result JSON;
  campaign_neft DECIMAL(18,8) := 0;
  campaign_xp INTEGER := 0;
  available_neft DECIMAL(18,8) := 0;
BEGIN
  -- Simple query to get data from user_balances
  SELECT 
    COALESCE(total_neft_claimed, 0),
    COALESCE(total_xp_earned, 0),
    COALESCE(user_balances.available_neft, 0)
  INTO campaign_neft, campaign_xp, available_neft
  FROM user_balances 
  WHERE wallet_address = user_wallet;

  -- Build simple result
  SELECT json_build_object(
    'total_neft', campaign_neft,
    'total_xp', campaign_xp,
    'available_neft', available_neft,
    'wallet_address', user_wallet,
    'debug', 'simplified_function'
  ) INTO result;

  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| get_user_connections                        | 
BEGIN
  RETURN QUERY
  SELECT 
    u.social_provider as primary_provider,
    u.wallet_address as primary_wallet_address,
    u.wallet_type as primary_wallet_type,
    COALESCE(u.linked_social_accounts, '[]'::jsonb) as linked_social_accounts,
    COALESCE(u.linked_wallet_addresses, '[]'::jsonb) as linked_wallet_addresses,
    (
      COALESCE(jsonb_array_length(u.linked_social_accounts), 0) + 
      COALESCE(jsonb_array_length(u.linked_wallet_addresses), 0) + 1
    )::INTEGER as total_connections
  FROM users u
  WHERE u.wallet_address = user_wallet_address;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| get_user_connections_json                   | 
DECLARE
  result JSON;
  primary_connection JSON;
  linked_social JSON;
  linked_wallets JSON;
BEGIN
  SELECT json_build_object(
    'primary_provider', u.provider,
    'primary_wallet_address', u.wallet_address,
    'primary_wallet_type', u.wallet_type
  ) INTO primary_connection
  FROM users u
  WHERE u.wallet_address = user_wallet_address;

  SELECT COALESCE(json_agg(
    json_build_object(
      'provider', ls.provider,
      'account_id', ls.account_id,
      'username', ls.username,
      'linked_at', ls.created_at
    )
  ), '[]'::json) INTO linked_social
  FROM linked_social_accounts ls
  WHERE ls.wallet_address = user_wallet_address;

  SELECT COALESCE(json_agg(
    json_build_object(
      'wallet_address', lw.wallet_address,
      'wallet_type', lw.wallet_type,
      'linked_at', lw.created_at
    )
  ), '[]'::json) INTO linked_wallets
  FROM linked_wallet_addresses lw
  WHERE lw.primary_wallet_address = user_wallet_address;

  SELECT json_build_object(
    'primary_connection', primary_connection,
    'linked_social_accounts', linked_social,
    'linked_wallet_addresses', linked_wallets,
    'total_connections', COALESCE(json_array_length(linked_social), 0) + COALESCE(json_array_length(linked_wallets), 0)
  ) INTO result;

  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| get_user_daily_totals                       | 
BEGIN
  RETURN QUERY
  SELECT 
    COALESCE(total_neft_earned, 0.0),
    COALESCE(total_xp_earned, 0),
    COALESCE(total_claims, 0)
  FROM user_streaks 
  WHERE wallet_address = user_wallet;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| get_user_dashboard_data                     | 
DECLARE
    result JSON;
BEGIN
    WITH user_profile AS (
        SELECT 
            u.id,
            u.wallet_address,
            u.username,
            u.avatar_url,
            u.level,
            u.xp,
            u.created_at,
            u.updated_at
        FROM users u
        WHERE u.wallet_address = user_wallet_address
    ),
    user_balance AS (
        SELECT 
            COALESCE(ub.available_neft, 0) as neft_balance,
            COALESCE(ub.total_xp_earned, 0) as xp_balance,
            COALESCE(ub.staked_amount, 0) as staked_amount
        FROM user_balances ub
        WHERE ub.wallet_address = user_wallet_address
    ),
    user_achievements AS (
        SELECT 
            COUNT(*) as total,
            COUNT(CASE WHEN ua.completed THEN 1 END) as completed,
            CASE 
                WHEN COUNT(*) > 0 THEN (COUNT(CASE WHEN ua.completed THEN 1 END)::DECIMAL / COUNT(*)::DECIMAL) * 100
                ELSE 0
            END as completion_percentage
        FROM user_achievements ua
        WHERE ua.wallet_address = user_wallet_address
    ),
    recent_activity AS (
        SELECT json_agg(
            json_build_object(
                'id', ua.id,
                'type', ua.activity_type,
                'description', ua.description,
                'created_at', ua.created_at
            ) ORDER BY ua.created_at DESC
        ) as activities
        FROM user_activities ua
        WHERE ua.wallet_address = user_wallet_address
        LIMIT 10
    )
    SELECT json_build_object(
        'profile', row_to_json(up.*),
        'balance', row_to_json(ub.*),
        'achievements', row_to_json(ua.*),
        'recent_activity', COALESCE(ra.activities, '[]'::json)
    ) INTO result
    FROM user_profile up
    CROSS JOIN user_balance ub
    CROSS JOIN user_achievements ua
    CROSS JOIN recent_activity ra;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| get_user_neft_rank                          | 
BEGIN
  RETURN QUERY
  WITH ranked_users AS (
    SELECT 
      ub.wallet_address,
      (COALESCE(ub.total_neft_claimed, 0) + COALESCE(ur.total_neft_earned, 0)) as total_neft_claimed,
      ROW_NUMBER() OVER (ORDER BY (COALESCE(ub.total_neft_claimed, 0) + COALESCE(ur.total_neft_earned, 0)) DESC)::INTEGER as rank_position
    FROM user_balances ub
    LEFT JOIN user_referrals ur ON ur.wallet_address = ub.wallet_address
    WHERE (COALESCE(ub.total_neft_claimed, 0) + COALESCE(ur.total_neft_earned, 0)) > 0
  )
  SELECT 
    ru.wallet_address,
    ru.total_neft_claimed,
    ru.rank_position
  FROM ranked_users ru
  WHERE ru.wallet_address = user_wallet;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| get_user_nft_rank                           | 
BEGIN
  RETURN QUERY
  WITH nft_counts AS (
    SELECT 
      uim.wallet_address,
      COUNT(*)::INTEGER as nft_count
    FROM user_ipfs_mappings uim
    GROUP BY uim.wallet_address
  ),
  ranked_users AS (
    SELECT 
      nc.wallet_address,
      nc.nft_count,
      ROW_NUMBER() OVER (ORDER BY nc.nft_count DESC)::INTEGER as rank_position
    FROM nft_counts nc
    WHERE nc.nft_count > 0
  )
  SELECT 
    ru.wallet_address,
    ru.nft_count,
    ru.rank_position
  FROM ranked_users ru
  WHERE ru.wallet_address = user_wallet;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| get_user_project_stats                      | 
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'total_participations', COUNT(*),
        'completed_projects', COUNT(*) FILTER (WHERE completion_percentage = 100),
        'active_participations', COUNT(*) FILTER (WHERE completion_percentage < 100 AND completion_percentage > 0),
        'rewards_claimed_count', COUNT(*) FILTER (WHERE rewards_claimed = true),
        'average_completion', COALESCE(AVG(completion_percentage), 0),
        'participations', COALESCE(json_agg(
            json_build_object(
                'project_id', up.project_id,
                'joined_at', up.joined_at,
                'completed_tasks_count', up.completed_tasks_count,
                'total_tasks_count', up.total_tasks_count,
                'completion_percentage', up.completion_percentage,
                'rewards_claimed', up.rewards_claimed,
                'claimed_at', up.claimed_at
            )
        ), '[]'::json)
    ) INTO result
    FROM user_participations up
    WHERE up.wallet_address = p_wallet_address;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| get_user_referral_data                      | 
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'referral_code', ur.referral_code,
        'total_referrals', ur.total_referrals,
        'total_neft_earned', ur.total_neft_earned,
        'total_xp_earned', ur.total_xp_earned,
        'last_updated', ur.updated_at
    ) INTO result
    FROM user_referrals ur
    WHERE ur.wallet_address = user_wallet;
    
    RETURN COALESCE(result, json_build_object(
        'referral_code', null,
        'total_referrals', 0,
        'total_neft_earned', 0,
        'total_xp_earned', 0,
        'last_updated', NOW()
    ));
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| get_user_staking_summary                    | 
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'staked_nfts_count', COALESCE((SELECT COUNT(*) FROM staked_nfts WHERE wallet_address = user_wallet), 0),
        'staked_tokens_amount', COALESCE((SELECT SUM(amount) FROM staked_tokens WHERE wallet_address = user_wallet), 0),
        'daily_nft_rewards', COALESCE((SELECT SUM(daily_reward) FROM staked_nfts WHERE wallet_address = user_wallet), 0),
        'daily_token_rewards', COALESCE((SELECT SUM(daily_reward) FROM staked_tokens WHERE wallet_address = user_wallet), 0),
        'unclaimed_rewards', COALESCE((SELECT SUM(total_rewards) FROM staking_rewards WHERE wallet_address = user_wallet AND claimed = FALSE), 0)
    ) INTO result;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| get_user_staking_summary_with_rewards       | 
DECLARE
    staked_nfts_count INTEGER := 0;
    staked_tokens_amount DECIMAL(18,8) := 0;
    total_pending_rewards DECIMAL(18,8) := 0;
    daily_nft_rewards DECIMAL(18,8) := 0;
    daily_token_rewards DECIMAL(18,8) := 0;
    reward_generation_result JSON;
BEGIN
    -- First, generate any pending daily rewards for this user
    SELECT generate_user_daily_rewards(user_wallet) INTO reward_generation_result;
    
    -- Get staked NFTs count and daily rewards
    SELECT 
        COALESCE(COUNT(*), 0),
        COALESCE(SUM(daily_reward), 0)
    INTO staked_nfts_count, daily_nft_rewards
    FROM staked_nfts 
    WHERE wallet_address = user_wallet;

    -- Get staked tokens amount and daily rewards
    SELECT 
        COALESCE(SUM(amount), 0),
        COALESCE(SUM(daily_reward), 0)
    INTO staked_tokens_amount, daily_token_rewards
    FROM staked_tokens 
    WHERE wallet_address = user_wallet;

    -- Get pending rewards (after generation)
    SELECT COALESCE(SUM(reward_amount), 0)
    INTO total_pending_rewards
    FROM staking_rewards 
    WHERE wallet_address = user_wallet AND is_claimed = false;

    -- Return JSON result
    RETURN json_build_object(
        'staked_nfts_count', staked_nfts_count,
        'staked_tokens_amount', staked_tokens_amount,
        'total_pending_rewards', total_pending_rewards,
        'daily_nft_rewards', daily_nft_rewards,
        'daily_token_rewards', daily_token_rewards,
        'reward_generation', reward_generation_result
    );

EXCEPTION
    WHEN OTHERS THEN
        -- Return default values on error
        RETURN json_build_object(
            'staked_nfts_count', 0,
            'staked_tokens_amount', 0,
            'total_pending_rewards', 0,
            'daily_nft_rewards', 0,
            'daily_token_rewards', 0,
            'error', SQLERRM
        );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| get_user_streak_count                       | 
BEGIN
  RETURN COALESCE(
    (SELECT current_streak FROM user_streaks WHERE wallet_address = user_wallet),
    0
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| get_user_total_balances                     | 
BEGIN
  RETURN QUERY
  SELECT 
    COALESCE(ub.total_neft_claimed, 0) as total_neft,
    COALESCE(ub.total_xp_earned, 0) as total_xp
  FROM user_balances ub
  WHERE ub.wallet_address = user_wallet;
  
  -- If no record exists, return zeros
  IF NOT FOUND THEN
    RETURN QUERY SELECT 0::DECIMAL(18,8), 0::INTEGER;
  END IF;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| get_wallet_nft_stats                        | 
BEGIN
  RETURN QUERY
  SELECT 
    COUNT(*)::INTEGER as total_nfts,
    COUNT(*) FILTER (WHERE is_active = true)::INTEGER as active_nfts,
    COUNT(*) FILTER (WHERE is_active = false)::INTEGER as burned_nfts,
    jsonb_object_agg(
      rarity, 
      jsonb_build_object(
        'total', rarity_count,
        'active', active_count
      )
    ) as rarity_breakdown
  FROM (
    SELECT 
      rarity,
      COUNT(*)::INTEGER as rarity_count,
      COUNT(*) FILTER (WHERE is_active = true)::INTEGER as active_count
    FROM nft_collections 
    WHERE wallet_address = p_wallet_address
    GROUP BY rarity
  ) rarity_stats;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| handle_new_user                             | 
BEGIN
  -- Set last_login on insert/update
  NEW.last_login = now();
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| has_role                                    | 
BEGIN
  -- This is a placeholder function to resolve an error.
  -- It assumes a 'role' column exists on the 'users' table.
  -- It will default to false if the user or role is not found.
  RETURN EXISTS (
    SELECT 1
    FROM public.users
    WHERE id = auth.uid() AND role = role_name
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| initialize_pending_rewards                  | 
DECLARE
    users_initialized INTEGER := 0;
BEGIN
    -- Create initial records for all users with staked assets
    INSERT INTO user_pending_rewards (wallet_address, nft_pending_rewards, token_pending_rewards, total_pending_rewards)
    SELECT DISTINCT 
        wallet_address,
        0,
        0,
        0
    FROM (
        SELECT wallet_address FROM staked_nfts
        UNION
        SELECT wallet_address FROM staked_tokens
    ) all_stakers
    ON CONFLICT (wallet_address) DO NOTHING;
    
    GET DIAGNOSTICS users_initialized = ROW_COUNT;
    
    -- Run initial pending rewards calculation
    PERFORM update_all_pending_rewards();
    
    RETURN json_build_object(
        'success', true,
        'users_initialized', users_initialized,
        'message', 'Pending rewards system initialized successfully'
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| initialize_user_achievements                | 
DECLARE
  inserted_count INTEGER := 0;
BEGIN
  -- Insert locked achievements for all active achievements that don't exist for this user
  INSERT INTO user_achievements (wallet_address, achievement_key, status, current_progress)
  SELECT user_wallet, am.achievement_key, 'locked'::achievement_status, 0
  FROM achievements_master am
  WHERE am.is_active = TRUE
    AND NOT EXISTS (
      SELECT 1 FROM user_achievements ua 
      WHERE ua.wallet_address = user_wallet AND ua.achievement_key = am.achievement_key
    );
  
  GET DIAGNOSTICS inserted_count = ROW_COUNT;
  RETURN inserted_count;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| initialize_user_balance                     | 
BEGIN
  INSERT INTO user_balances (
    wallet_address, 
    total_neft_claimed, 
    total_xp_earned, 
    last_updated
  )
  VALUES (
    user_wallet, 
    0, 
    0, 
    NOW()
  )
  ON CONFLICT (wallet_address) DO NOTHING;

  RETURN TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RAISE LOG 'Error in initialize_user_balance: %', SQLERRM;
    RETURN FALSE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| initialize_user_referrals                   | 
BEGIN
  INSERT INTO referral_codes (wallet_address, referral_code)
  VALUES (user_wallet, referral_code)
  ON CONFLICT (wallet_address) 
  DO UPDATE SET referral_code = EXCLUDED.referral_code
  WHERE referral_codes.referral_code IS NULL OR referral_codes.referral_code = '';
  
  RETURN json_build_object(
    'success', true,
    'referral_code', referral_code,
    'message', 'Referral system initialized successfully'
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| link_account_to_user                        | 
DECLARE
  user_record RECORD;
BEGIN
  -- Get the user record
  SELECT * INTO user_record FROM users WHERE wallet_address = user_wallet_address;
  
  IF NOT FOUND THEN
    RETURN FALSE;
  END IF;
  
  -- Check if account is already linked to another user
  IF check_linked_account_exists(account_type, account_id, user_record.id) THEN
    RETURN FALSE;
  END IF;
  
  -- Add the account to the user's linked accounts
  IF account_type = 'wallet' THEN
    UPDATE users 
    SET linked_wallet_addresses = linked_wallet_addresses || jsonb_build_array(account_id)
    WHERE wallet_address = user_wallet_address;
  ELSIF account_type = 'social' THEN
    UPDATE users 
    SET linked_social_accounts = linked_social_accounts || jsonb_build_array(account_id)
    WHERE wallet_address = user_wallet_address;
  END IF;
  
  RETURN TRUE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| link_additional_provider                    | 
DECLARE
  existing_user RECORD;
  existing_connection RECORD;
  current_connections JSONB;
  timestamp_now TIMESTAMPTZ := now();
BEGIN
  -- Check if the new address already exists anywhere
  SELECT * INTO existing_connection FROM find_user_by_any_address(new_address) LIMIT 1;
  
  IF existing_connection.user_id IS NOT NULL THEN
    -- Address already exists in another account or same account
    SELECT * INTO existing_user FROM find_user_by_any_address(target_user_address) LIMIT 1;
    
    IF existing_user.user_id IS NULL THEN
      -- Target user doesn't exist
      RETURN FALSE;
    END IF;
    
    IF existing_connection.user_id != existing_user.user_id THEN
      -- Address belongs to different user
      RETURN FALSE;
    END IF;
    
    -- Address already belongs to same user - no action needed
    RETURN TRUE;
  END IF;
  
  -- Find target user
  SELECT * INTO existing_user FROM find_user_by_any_address(target_user_address) LIMIT 1;
  
  IF existing_user.user_id IS NULL THEN
    RETURN FALSE;
  END IF;
  
  -- Add connection based on method
  IF link_method = 'social' THEN
    -- Get current social connections
    SELECT COALESCE(linked_social_accounts, '[]'::jsonb) INTO current_connections
    FROM users WHERE id = existing_user.user_id;
    
    -- Check if provider already connected
    IF jsonb_path_exists(
      current_connections, 
      ('$[*] ? (@.provider == "' || new_provider || '")')::jsonpath
    ) THEN
      RETURN FALSE; -- Provider already connected
    END IF;
    
    -- Add social connection
    UPDATE users 
    SET 
      linked_social_accounts = current_connections || jsonb_build_array(
        jsonb_build_object(
          'provider', new_provider,
          'provider_id', COALESCE(provider_id, split_part(new_address, ':', 3)),
          'email', provider_email,
          'username', provider_username,
          'social_address', new_address,
          'connected_at', timestamp_now,
          'is_primary', false
        )
      ),
      connection_history = COALESCE(connection_history, '[]'::jsonb) || jsonb_build_array(
        jsonb_build_object(
          'action', 'social_linked',
          'provider', new_provider,
          'address', new_address,
          'timestamp', timestamp_now
        )
      ),
      updated_at = timestamp_now
    WHERE id = existing_user.user_id;
    
  ELSIF link_method = 'wallet' THEN
    -- Get current wallet connections
    SELECT COALESCE(linked_wallet_addresses, '[]'::jsonb) INTO current_connections
    FROM users WHERE id = existing_user.user_id;
    
    -- Check if wallet address already connected
    IF jsonb_path_exists(
      current_connections, 
      ('$[*] ? (@.address == "' || new_address || '")')::jsonpath
    ) THEN
      RETURN FALSE; -- Wallet already connected
    END IF;
    
    -- Add wallet connection
    UPDATE users 
    SET 
      linked_wallet_addresses = current_connections || jsonb_build_array(
        jsonb_build_object(
          'address', new_address,
          'wallet_type', new_provider,
          'connected_at', timestamp_now,
          'is_primary', false
        )
      ),
      connection_history = COALESCE(connection_history, '[]'::jsonb) || jsonb_build_array(
        jsonb_build_object(
          'action', 'wallet_linked',
          'wallet_type', new_provider,
          'address', new_address,
          'timestamp', timestamp_now
        )
      ),
      updated_at = timestamp_now
    WHERE id = existing_user.user_id;
  END IF;
  
  RETURN TRUE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| log_user_activity                           | 
DECLARE
  activity_id UUID;
BEGIN
  -- Insert the activity
  INSERT INTO user_activities (
    wallet_address, activity_type, activity_title, activity_description, 
    details, neft_reward, xp_reward, nft_reward, status, metadata
  ) VALUES (
    user_wallet, activity_type_param, title, description, 
    details_param, neft_reward_param, xp_reward_param, nft_reward_param, status_param, metadata_param
  ) RETURNING id INTO activity_id;

  -- Update or create activity statistics
  INSERT INTO user_activity_stats (
    wallet_address, total_activities, 
    total_tasks_completed, total_claims, total_burns, total_stakes,
    total_neft_earned, total_xp_earned, last_activity_at
  ) VALUES (
    user_wallet, 1,
    CASE WHEN activity_type_param = 'task' THEN 1 ELSE 0 END,
    CASE WHEN activity_type_param IN ('claim', 'daily_claim', 'achievement') THEN 1 ELSE 0 END,
    CASE WHEN activity_type_param = 'burn' THEN 1 ELSE 0 END,
    CASE WHEN activity_type_param IN ('stake', 'unstake') THEN 1 ELSE 0 END,
    neft_reward_param, xp_reward_param, NOW()
  )
  ON CONFLICT (wallet_address) DO UPDATE SET
    total_activities = user_activity_stats.total_activities + 1,
    total_tasks_completed = user_activity_stats.total_tasks_completed + 
      CASE WHEN activity_type_param = 'task' THEN 1 ELSE 0 END,
    total_claims = user_activity_stats.total_claims + 
      CASE WHEN activity_type_param IN ('claim', 'daily_claim', 'achievement') THEN 1 ELSE 0 END,
    total_burns = user_activity_stats.total_burns + 
      CASE WHEN activity_type_param = 'burn' THEN 1 ELSE 0 END,
    total_stakes = user_activity_stats.total_stakes + 
      CASE WHEN activity_type_param IN ('stake', 'unstake') THEN 1 ELSE 0 END,
    total_neft_earned = user_activity_stats.total_neft_earned + neft_reward_param,
    total_xp_earned = user_activity_stats.total_xp_earned + xp_reward_param,
    last_activity_at = NOW();

  RETURN activity_id;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| mark_nfts_as_burned                         | 
DECLARE
  updated_count INTEGER;
BEGIN
  UPDATE nft_collections 
  SET 
    is_active = false,
    burned_at = NOW(),
    burn_transaction_id = p_burn_transaction_id
  WHERE nft_id = ANY(p_nft_ids)
    AND is_active = true;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RETURN updated_count;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| process_daily_claim                         | 
DECLARE
  user_record RECORD;
  reward_data RECORD;
  calculated_streak INTEGER;
  total_reward_neft DECIMAL(18,8);
  total_reward_xp INTEGER;
  hours_since_last_claim NUMERIC;
BEGIN
  -- Get user streak record
  SELECT * INTO user_record FROM user_streaks WHERE wallet_address = user_wallet;

  -- Check 24-hour cooldown
  IF user_record IS NOT NULL AND user_record.last_claimed_at IS NOT NULL THEN
    -- Calculate hours since last claim
    SELECT EXTRACT(EPOCH FROM (NOW() - user_record.last_claimed_at)) / 3600 INTO hours_since_last_claim;
    
    -- If less than 24 hours, return error with remaining time
    IF hours_since_last_claim < 24 THEN
      RETURN QUERY SELECT 
        FALSE, 
        CONCAT('Must wait ', ROUND(24 - hours_since_last_claim, 1), ' more hours before next claim')::TEXT,
        COALESCE(user_record.current_streak, 0), 
        0.0::DECIMAL(18,8), 
        0, 
        ''::TEXT, 
        NULL::JSONB, 
        FALSE,
        0.0::DECIMAL(18,8), 
        0;
      RETURN;
    END IF;
  END IF;

  -- Also check daily_claims table for same calendar date (backup check)
  IF EXISTS (SELECT 1 FROM daily_claims WHERE wallet_address = user_wallet AND claim_date = CURRENT_DATE) THEN
    RETURN QUERY SELECT 
      FALSE, 'Already claimed today'::TEXT,
      0, 0.0::DECIMAL(18,8), 0, ''::TEXT, NULL::JSONB, FALSE,
      0.0::DECIMAL(18,8), 0;
    RETURN;
  END IF;

  -- Create or update user streak record
  IF user_record IS NULL THEN
    calculated_streak := 1;
    INSERT INTO user_streaks (
      wallet_address, current_streak, longest_streak, last_claim_date, 
      total_claims, streak_started_at, total_neft_earned, total_xp_earned,
      last_claimed_at
    ) VALUES (
      user_wallet, 1, 1, CURRENT_DATE, 1, CURRENT_DATE, 0, 0, NOW()
    );
  ELSE
    -- Calculate streak continuation (24-hour based)
    IF user_record.last_claimed_at IS NOT NULL AND 
       user_record.last_claimed_at >= (NOW() - INTERVAL '48 hours') THEN
      calculated_streak := user_record.current_streak + 1;
    ELSE
      calculated_streak := 1;
    END IF;
  END IF;

  -- Get reward calculation
  SELECT * INTO reward_data FROM calculate_daily_reward(calculated_streak, user_wallet);
  
  total_reward_neft := reward_data.base_neft + reward_data.bonus_neft;
  total_reward_xp := reward_data.base_xp + reward_data.bonus_xp;

  -- Update user streaks with 24-hour timestamp
  UPDATE user_streaks SET
    current_streak = calculated_streak,
    longest_streak = GREATEST(longest_streak, calculated_streak),
    last_claim_date = CURRENT_DATE,
    last_claimed_at = NOW(),
    total_claims = total_claims + 1,
    total_neft_earned = total_neft_earned + total_reward_neft,
    total_xp_earned = total_xp_earned + total_reward_xp
  WHERE wallet_address = user_wallet;

  -- Record the claim
  INSERT INTO daily_claims (
    wallet_address, claim_date, streak_count, 
    base_neft_reward, bonus_neft_reward, 
    base_xp_reward, bonus_xp_reward,
    nft_reward, reward_tier
  ) VALUES (
    user_wallet, CURRENT_DATE, calculated_streak,
    reward_data.base_neft, reward_data.bonus_neft,
    reward_data.base_xp, reward_data.bonus_xp,
    reward_data.nft_reward, reward_data.reward_tier
  );

  -- Update user_balances table
  INSERT INTO user_balances (
    wallet_address, 
    total_neft_claimed, 
    total_xp_earned, 
    last_updated
  ) VALUES (
    user_wallet, 
    total_reward_neft, 
    total_reward_xp,
    NOW()
  )
  ON CONFLICT (wallet_address) DO UPDATE SET
    total_neft_claimed = user_balances.total_neft_claimed + total_reward_neft,
    total_xp_earned = user_balances.total_xp_earned + total_reward_xp,
    last_updated = NOW();

  -- Return success result
  RETURN QUERY SELECT 
    TRUE,
    'Daily reward claimed successfully!'::TEXT,
    calculated_streak,
    total_reward_neft,
    total_reward_xp,
    reward_data.reward_tier,
    reward_data.nft_reward,
    reward_data.is_milestone,
    total_reward_neft,
    total_reward_xp;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| process_daily_claim_optimized               | 
DECLARE
  calculated_streak INTEGER := 0;
  reward_data RECORD;
  next_reward_data RECORD;
  user_record RECORD;
  new_total_neft DECIMAL(18,8);
  new_total_xp INTEGER;
  total_reward_neft DECIMAL(18,8);
  total_reward_xp INTEGER;
BEGIN
  -- Check if user can claim today
  IF EXISTS (SELECT 1 FROM daily_claims WHERE wallet_address = user_wallet AND claim_date = CURRENT_DATE) THEN
    RETURN QUERY SELECT 
      FALSE, 'Already claimed today'::TEXT,
      0, 0.0::DECIMAL(18,8), 0, ''::TEXT, NULL::JSONB, FALSE,
      0, 0, 0, 0.0::DECIMAL(18,8), 0, FALSE,
      0, 0.0::DECIMAL(18,8), 0, ''::TEXT, FALSE;
    RETURN;
  END IF;

  -- Get or create user streak record
  SELECT * INTO user_record FROM user_streaks WHERE wallet_address = user_wallet;

  IF user_record IS NULL THEN
    calculated_streak := 1;
    INSERT INTO user_streaks (
      wallet_address, current_streak, longest_streak, last_claim_date, 
      total_claims, streak_started_at, total_neft_earned, total_xp_earned
    ) VALUES (
      user_wallet, 1, 1, CURRENT_DATE, 1, CURRENT_DATE, 0, 0
    );
  ELSE
    -- Calculate streak continuation
    IF user_record.last_claim_date = CURRENT_DATE - INTERVAL '1 day' THEN
      calculated_streak := user_record.current_streak + 1;
    ELSE
      calculated_streak := 1;
    END IF;
  END IF;

  -- Calculate current claim reward
  SELECT * INTO reward_data FROM calculate_daily_reward(calculated_streak, user_wallet);
  total_reward_neft := reward_data.base_neft + reward_data.bonus_neft;
  total_reward_xp := reward_data.base_xp + reward_data.bonus_xp;

  -- Calculate new totals
  new_total_neft := COALESCE(user_record.total_neft_earned, 0) + total_reward_neft;
  new_total_xp := COALESCE(user_record.total_xp_earned, 0) + total_reward_xp;

  -- Update user streaks
  UPDATE user_streaks SET
    current_streak = calculated_streak,
    longest_streak = GREATEST(COALESCE(longest_streak, 0), calculated_streak),
    last_claim_date = CURRENT_DATE,
    total_claims = COALESCE(total_claims, 0) + 1,
    total_neft_earned = new_total_neft,
    total_xp_earned = new_total_xp,
    last_updated = NOW(),
    streak_started_at = CASE 
      WHEN calculated_streak = 1 THEN CURRENT_DATE 
      ELSE COALESCE(streak_started_at, CURRENT_DATE)
    END
  WHERE wallet_address = user_wallet;

  -- Record the claim
  INSERT INTO daily_claims (
    wallet_address, claim_date, streak_count, 
    base_neft_reward, bonus_neft_reward, 
    base_xp_reward, bonus_xp_reward,
    nft_reward, reward_tier
  ) VALUES (
    user_wallet, CURRENT_DATE, calculated_streak,
    reward_data.base_neft, reward_data.bonus_neft,
    reward_data.base_xp, reward_data.bonus_xp,
    reward_data.nft_reward, reward_data.reward_tier
  );

  -- Update user_balances table (using actual table schema)
  INSERT INTO user_balances (
    wallet_address, 
    total_neft_claimed, 
    total_xp_earned, 
    last_updated
  ) VALUES (
    user_wallet, 
    total_reward_neft, 
    total_reward_xp,
    NOW()
  )
  ON CONFLICT (wallet_address) DO UPDATE SET
    total_neft_claimed = user_balances.total_neft_claimed + total_reward_neft,
    total_xp_earned = user_balances.total_xp_earned + total_reward_xp,
    last_updated = NOW();

  -- Pre-calculate next claim reward (avoid future RPC call)
  SELECT * INTO next_reward_data FROM calculate_daily_reward(calculated_streak + 1, user_wallet);

  -- Return comprehensive result (eliminates need for additional queries)
  RETURN QUERY SELECT 
    TRUE, 
    CASE 
      WHEN reward_data.is_milestone THEN 'Milestone achieved! ' || reward_data.reward_tier || ' unlocked!'
      ELSE 'Daily reward claimed successfully!'
    END,
    
    -- Claim Results
    calculated_streak,
    total_reward_neft,
    total_reward_xp,
    reward_data.reward_tier,
    reward_data.nft_reward,
    reward_data.is_milestone,
    
    -- Updated User State
    calculated_streak, -- new_current_streak
    GREATEST(COALESCE(user_record.longest_streak, 0), calculated_streak), -- new_longest_streak
    COALESCE(user_record.total_claims, 0) + 1, -- new_total_claims
    new_total_neft,
    new_total_xp,
    FALSE, -- can_claim_tomorrow (just claimed today)
    
    -- Next Claim Preview
    calculated_streak + 1, -- next_streak
    next_reward_data.base_neft + next_reward_data.bonus_neft, -- next_neft_reward
    next_reward_data.base_xp + next_reward_data.bonus_xp, -- next_xp_reward
    next_reward_data.reward_tier, -- next_reward_tier
    next_reward_data.is_milestone; -- next_is_milestone
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| process_referral                            | 
DECLARE
  v_referral_code TEXT;
BEGIN
  -- Validation checks
  IF p_referrer_wallet = p_referred_wallet THEN
    RETURN json_build_object('success', false, 'error', 'Self-referral not allowed');
  END IF;

  -- Get referrer's code and check if referrer exists
  SELECT referral_code INTO v_referral_code
  FROM public.user_referrals 
  WHERE wallet_address = p_referrer_wallet;
  
  IF v_referral_code IS NULL THEN
    RETURN json_build_object('success', false, 'error', 'Invalid referrer wallet');
  END IF;

  -- Insert referral reward (will fail on duplicate due to constraint)
  INSERT INTO public.referral_rewards (
    referrer_wallet, 
    referred_wallet, 
    referral_code, 
    neft_reward, 
    status, 
    completed_at
  ) VALUES (
    p_referrer_wallet, 
    p_referred_wallet, 
    v_referral_code, 
    p_neft_reward, 
    'completed', 
    NOW()
  );

  -- Update aggregates atomically
  UPDATE public.user_referrals 
  SET 
    total_referrals = total_referrals + 1,
    total_neft_earned = total_neft_earned + p_neft_reward,
    updated_at = NOW()
  WHERE wallet_address = p_referrer_wallet;

  RETURN json_build_object('success', true, 'neft_reward', p_neft_reward);

EXCEPTION 
  WHEN unique_violation THEN
    RETURN json_build_object('success', false, 'error', 'Referral already processed');
  WHEN OTHERS THEN
    RETURN json_build_object('success', false, 'error', SQLERRM);
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| process_referral                            | 
DECLARE
  referral_code_val TEXT;
  current_referrals INTEGER;
  tier_reached INTEGER := 0;
  neft_reward DECIMAL(18,2) := 0;
  xp_reward INTEGER := 0;
  result JSON;
BEGIN
  -- Get referrer's referral code
  SELECT rc.referral_code INTO referral_code_val
  FROM referral_codes rc
  WHERE rc.wallet_address = referrer_wallet;
  
  IF referral_code_val IS NULL THEN
    RETURN json_build_object('success', false, 'message', 'Referrer not found');
  END IF;
  
  -- Check if referee is already referred
  IF EXISTS (SELECT 1 FROM referrals WHERE referee_wallet = referee_wallet) THEN
    RETURN json_build_object('success', false, 'message', 'User already referred');
  END IF;
  
  -- Insert the referral
  INSERT INTO referrals (referrer_wallet, referee_wallet, referral_code, status, processed_at)
  VALUES (referrer_wallet, referee_wallet, referral_code_val, 'processed', NOW());
  
  -- Update referrer's stats
  UPDATE referral_codes 
  SET total_referrals = total_referrals + 1
  WHERE wallet_address = referrer_wallet;
  
  -- Get updated referral count
  SELECT total_referrals INTO current_referrals
  FROM referral_codes
  WHERE wallet_address = referrer_wallet;
  
  -- Calculate tier and rewards based on referral count
  CASE 
    WHEN current_referrals >= 50 THEN
      tier_reached := 5;
      neft_reward := 1500;
      xp_reward := 3000;
    WHEN current_referrals >= 25 THEN
      tier_reached := 4;
      neft_reward := 500;
      xp_reward := 1000;
    WHEN current_referrals >= 10 THEN
      tier_reached := 3;
      neft_reward := 150;
      xp_reward := 300;
    WHEN current_referrals >= 5 THEN
      tier_reached := 2;
      neft_reward := 50;
      xp_reward := 100;
    WHEN current_referrals >= 1 THEN
      tier_reached := 1;
      neft_reward := 25;
      xp_reward := 50;
  END CASE;
  
  -- Update referral record with rewards
  UPDATE referrals 
  SET neft_reward = process_referral.neft_reward,
      xp_reward = process_referral.xp_reward,
      tier_reached = process_referral.tier_reached
  WHERE referee_wallet = process_referral.referee_wallet;
  
  -- Update referrer's tier if advanced
  UPDATE referral_codes 
  SET current_tier = GREATEST(current_tier, tier_reached),
      total_neft_earned = total_neft_earned + neft_reward,
      total_xp_earned = total_xp_earned + xp_reward
  WHERE wallet_address = referrer_wallet;
  
  -- Add rewards to user balance
  INSERT INTO user_balances (wallet_address, total_neft_claimed, available_neft, total_xp_earned, available_xp, last_updated)
  VALUES (referrer_wallet, neft_reward, neft_reward, xp_reward, xp_reward, NOW())
  ON CONFLICT (wallet_address) 
  DO UPDATE SET 
    total_neft_claimed = user_balances.total_neft_claimed + EXCLUDED.total_neft_claimed,
    available_neft = user_balances.available_neft + EXCLUDED.available_neft,
    total_xp_earned = user_balances.total_xp_earned + EXCLUDED.total_xp_earned,
    available_xp = user_balances.available_xp + EXCLUDED.available_xp,
    last_updated = NOW();
  
  -- Return success result
  SELECT json_build_object(
    'success', true,
    'tier_reached', tier_reached,
    'neft_reward', neft_reward,
    'xp_reward', xp_reward,
    'total_referrals', current_referrals,
    'message', 'Referral processed successfully'
  ) INTO result;
  
  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| process_referral_by_wallets                 | 
DECLARE
  current_referrals INTEGER;
  tier_reached INTEGER := 0;
  neft_reward DECIMAL(18,2) := 0;
  xp_reward INTEGER := 0;
  result JSON;
BEGIN
  -- Check if referee is already referred
  IF EXISTS (SELECT 1 FROM referrals WHERE referee_wallet = process_referral_by_wallets.referee_wallet) THEN
    RETURN json_build_object('success', false, 'message', 'User already referred');
  END IF;
  
  -- Insert the referral
  INSERT INTO referrals (referrer_wallet, referee_wallet, neft_reward, xp_reward)
  VALUES (referrer_wallet, referee_wallet, 25, 50); -- Base rewards
  
  -- Update or create referral stats for referrer
  INSERT INTO referral_stats (wallet_address, total_referrals, total_neft_earned, total_xp_earned, updated_at)
  VALUES (referrer_wallet, 1, 25, 50, NOW())
  ON CONFLICT (wallet_address) 
  DO UPDATE SET 
    total_referrals = referral_stats.total_referrals + 1,
    total_neft_earned = referral_stats.total_neft_earned + 25,
    total_xp_earned = referral_stats.total_xp_earned + 50,
    updated_at = NOW();
  
  -- Get updated referral count
  SELECT total_referrals INTO current_referrals
  FROM referral_stats
  WHERE wallet_address = referrer_wallet;
  
  -- Calculate tier reached based on referral count
  IF current_referrals >= 10 THEN
    tier_reached := 3;
  ELSIF current_referrals >= 5 THEN
    tier_reached := 2;
  ELSIF current_referrals >= 1 THEN
    tier_reached := 1;
  END IF;
  
  -- Update current tier
  UPDATE referral_stats 
  SET current_tier = tier_reached
  WHERE wallet_address = referrer_wallet;
  
  SELECT json_build_object(
    'success', true,
    'message', 'Referral processed successfully',
    'tier_reached', tier_reached,
    'total_referrals', current_referrals,
    'neft_reward', 25,
    'xp_reward', 50
  ) INTO result;
  
  RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| process_referral_from_code                  | 
DECLARE
  referrer_wallet TEXT;
  current_referrals INTEGER;
BEGIN
  -- Find referrer by code
  SELECT wallet_address INTO referrer_wallet
  FROM referral_codes
  WHERE referral_codes.referral_code = process_referral_from_code.referral_code;
  
  IF referrer_wallet IS NULL THEN
    RETURN json_build_object('success', false, 'message', 'Invalid referral code');
  END IF;
  
  -- Check if referee already referred
  IF EXISTS (SELECT 1 FROM referrals WHERE referee_wallet = process_referral_from_code.referee_wallet) THEN
    RETURN json_build_object('success', false, 'message', 'User already referred');
  END IF;
  
  -- Insert referral
  INSERT INTO referrals (referrer_wallet, referee_wallet, referral_code, neft_reward, xp_reward)
  VALUES (referrer_wallet, referee_wallet, referral_code, 25, 50);
  
  -- Update referrer stats
  UPDATE referral_codes 
  SET 
    total_referrals = total_referrals + 1,
    total_neft_earned = total_neft_earned + 25,
    total_xp_earned = total_xp_earned + 50,
    current_tier = CASE 
      WHEN total_referrals + 1 >= 10 THEN 3
      WHEN total_referrals + 1 >= 5 THEN 2
      WHEN total_referrals + 1 >= 1 THEN 1
      ELSE 0
    END
  WHERE wallet_address = referrer_wallet;
  
  -- Get updated count
  SELECT total_referrals INTO current_referrals
  FROM referral_codes
  WHERE wallet_address = referrer_wallet;
  
  RETURN json_build_object(
    'success', true,
    'message', 'Referral processed successfully',
    'total_referrals', current_referrals,
    'neft_reward', 25,
    'xp_reward', 50
  );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| process_referral_reward                     | 
DECLARE
    referral_code_val TEXT;
    result JSON;
BEGIN
    -- Get referral code for the referrer
    SELECT referral_code INTO referral_code_val
    FROM user_referrals 
    WHERE wallet_address = referrer_wallet;
    
    IF referral_code_val IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'Referrer not found');
    END IF;
    
    -- Check if this referral already exists
    IF EXISTS (
        SELECT 1 FROM referral_rewards 
        WHERE referrer_wallet = referrer_wallet 
        AND referred_wallet = referred_wallet
    ) THEN
        RETURN json_build_object('success', false, 'error', 'Referral already processed');
    END IF;
    
    -- Insert referral reward record
    INSERT INTO referral_rewards (
        referrer_wallet, 
        referred_wallet, 
        referral_code, 
        neft_reward, 
        xp_reward, 
        status,
        completed_at
    ) VALUES (
        referrer_wallet, 
        referred_wallet, 
        referral_code_val, 
        neft_reward, 
        xp_reward, 
        'completed',
        NOW()
    );
    
    -- Update referrer's referral stats
    UPDATE user_referrals SET
        total_referrals = total_referrals + 1,
        total_neft_earned = total_neft_earned + neft_reward,
        total_xp_earned = total_xp_earned + xp_reward,
        updated_at = NOW()
    WHERE wallet_address = referrer_wallet;
    
    result := json_build_object(
        'success', true,
        'referrer_wallet', referrer_wallet,
        'referred_wallet', referred_wallet,
        'neft_reward', neft_reward,
        'xp_reward', xp_reward,
        'referral_code', referral_code_val
    );
    
    RETURN result;
EXCEPTION
    WHEN OTHERS THEN
        RETURN json_build_object(
            'success', false, 
            'error', SQLERRM,
            'sqlstate', SQLSTATE
        );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| register_referral_code                      | 
BEGIN
  INSERT INTO referral_code_mapping (referral_code, wallet_address)
  VALUES (referral_code, user_wallet)
  ON CONFLICT (referral_code) DO NOTHING;
  
  RETURN json_build_object('success', true, 'message', 'Referral code registered');
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| remove_social_connection                    | 
DECLARE
  current_connections JSONB;
  filtered_connections JSONB;
BEGIN
  -- Get current connections
  SELECT COALESCE(linked_social_accounts, '[]'::jsonb) INTO current_connections
  FROM users 
  WHERE wallet_address = primary_wallet_address;
  
  -- Filter out the connection to remove
  SELECT jsonb_agg(connection)
  INTO filtered_connections
  FROM jsonb_array_elements(current_connections) AS connection
  WHERE connection->>'provider' != provider_name;
  
  -- Update with filtered connections
  UPDATE users 
  SET 
    linked_social_accounts = COALESCE(filtered_connections, '[]'::jsonb),
    connection_history = COALESCE(connection_history, '[]'::jsonb) || jsonb_build_array(
      jsonb_build_object(
        'action', 'social_disconnected',
        'provider', provider_name,
        'timestamp', now()
      )
    ),
    updated_at = now()
  WHERE wallet_address = primary_wallet_address;
  
  RETURN FOUND;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| remove_wallet_connection                    | 
DECLARE
  current_connections JSONB;
  filtered_connections JSONB;
BEGIN
  -- Get current connections
  SELECT COALESCE(linked_wallet_addresses, '[]'::jsonb) INTO current_connections
  FROM users 
  WHERE wallet_address = primary_wallet_address;
  
  -- Filter out the connection to remove
  SELECT jsonb_agg(connection)
  INTO filtered_connections
  FROM jsonb_array_elements(current_connections) AS connection
  WHERE connection->>'address' != wallet_address_to_remove;
  
  -- Update with filtered connections
  UPDATE users 
  SET 
    linked_wallet_addresses = COALESCE(filtered_connections, '[]'::jsonb),
    connection_history = COALESCE(connection_history, '[]'::jsonb) || jsonb_build_array(
      jsonb_build_object(
        'action', 'wallet_disconnected',
        'address', wallet_address_to_remove,
        'timestamp', now()
      )
    ),
    updated_at = now()
  WHERE wallet_address = primary_wallet_address;
  
  RETURN FOUND;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| rollback_transaction                        | 
BEGIN
    -- Rollback transaction (this is implicit in Supabase)
    RAISE EXCEPTION 'Transaction rolled back';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| schedule_daily_reward_generation            | 
DECLARE
    last_generation_date DATE;
    current_date DATE := CURRENT_DATE;
    generation_result JSON;
BEGIN
    -- Check if rewards have already been generated today
    SELECT MAX(DATE(created_at)) INTO last_generation_date
    FROM staking_rewards;
    
    -- Only generate if not already done today
    IF last_generation_date IS NULL OR last_generation_date < current_date THEN
        SELECT generate_all_users_daily_rewards() INTO generation_result;
        RETURN generation_result;
    ELSE
        RETURN json_build_object(
            'success', true,
            'message', 'Rewards already generated for today',
            'last_generation_date', last_generation_date,
            'current_date', current_date
        );
    END IF;

EXCEPTION WHEN OTHERS THEN
    RETURN json_build_object(
        'success', false,
        'error', SQLERRM,
        'message', 'Failed to schedule daily reward generation'
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| search_projects                             | 
DECLARE
    result JSON;
    total_count INTEGER;
BEGIN
    WITH sorted_projects AS (
        SELECT 
            p.*,
            CASE 
                WHEN p.end_date < NOW() THEN 'ended'
                WHEN p.start_date > NOW() THEN 'upcoming'
                ELSE 'active'
            END as status,
            CASE 
                WHEN p.end_date > NOW() THEN EXTRACT(EPOCH FROM (p.end_date - NOW()))
                ELSE 0
            END as seconds_remaining
        FROM projects p
        WHERE p.is_active = true
            AND (p_category = 'all' OR p.category = p_category OR (p_category = 'featured' AND p.is_featured = true))
            AND (p_status = 'all' OR 
                 (p_status = 'active' AND p.start_date <= NOW() AND (p.end_date IS NULL OR p.end_date > NOW())) OR
                 (p_status = 'ended' AND p.end_date < NOW()) OR
                 (p_status = 'upcoming' AND p.start_date > NOW()))
            AND (p_query = '' OR 
                 p.title ILIKE '%' || p_query || '%' OR 
                 p.collection_name ILIKE '%' || p_query || '%')
        ORDER BY 
            CASE p_sort_by
                WHEN 'end_date' THEN p.end_date
                WHEN 'reward' THEN NULL
                WHEN 'participants' THEN NULL
                ELSE p.created_at
            END DESC NULLS LAST
        LIMIT p_limit OFFSET p_offset
    )
    SELECT COUNT(*) INTO total_count FROM sorted_projects;
    
    SELECT json_build_object(
        'results', COALESCE(json_agg(sp.*), '[]'::json),
        'total_count', total_count,
        'has_more', (p_offset + p_limit) < total_count
    ) INTO result
    FROM sorted_projects sp;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| stake_neft_tokens                           | 
DECLARE
    daily_reward DECIMAL(18,8);
    current_available DECIMAL(18,8) := 0;
BEGIN
    IF stake_amount <= 0 THEN
        RETURN json_build_object('success', false, 'error', 'Amount must be greater than 0');
    END IF;
    
    -- Check available balance from user_balances table
    SELECT COALESCE(available_neft, 0) INTO current_available
    FROM user_balances WHERE wallet_address = user_wallet;
    
    IF current_available < stake_amount THEN
        RETURN json_build_object('success', false, 'error', format('Insufficient balance. Available: %s, Required: %s', current_available, stake_amount));
    END IF;
    
    daily_reward := (stake_amount * apr_rate / 100) / 365;
    
    -- Update user balance (deduct staked amount)
    UPDATE user_balances 
    SET available_neft = available_neft - stake_amount,
        last_updated = NOW()
    WHERE wallet_address = user_wallet;
    
    -- Insert staked tokens
    INSERT INTO staked_tokens (wallet_address, amount, apr_rate, daily_reward)
    VALUES (user_wallet, stake_amount, apr_rate, daily_reward);
    
    RETURN json_build_object(
        'success', true,
        'message', format('Successfully staked %s NEFT! Daily reward: %s NEFT', stake_amount, daily_reward),
        'staked_amount', stake_amount,
        'daily_reward', daily_reward
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| stake_nft                                   | 
DECLARE
    daily_reward DECIMAL(18,8);
BEGIN
    daily_reward := CASE nft_rarity
        WHEN 'Common' THEN 0.1
        WHEN 'Rare' THEN 0.4
        WHEN 'Legendary' THEN 1.0
        WHEN 'Platinum' THEN 2.5
        WHEN 'Silver' THEN 8.0
        WHEN 'Gold' THEN 30.0
        ELSE 0.1
    END;
    
    IF EXISTS (SELECT 1 FROM staked_nfts WHERE wallet_address = user_wallet AND staked_nfts.nft_id = stake_nft.nft_id) THEN
        RETURN json_build_object('success', false, 'error', 'NFT is already staked');
    END IF;
    
    INSERT INTO staked_nfts (wallet_address, nft_id, nft_rarity, daily_reward)
    VALUES (user_wallet, nft_id, nft_rarity, daily_reward);
    
    RETURN json_build_object(
        'success', true,
        'message', format('Successfully staked %s NFT! Daily reward: %s NEFT', nft_rarity, daily_reward),
        'daily_reward', daily_reward
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| switch_to_automatic_rewards                 | 
DECLARE
    deleted_count INTEGER;
BEGIN
    -- Delete manually generated rewards for today (to prevent double rewards)
    DELETE FROM staking_rewards 
    WHERE reward_date = CURRENT_DATE;
    
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    
    -- Update last_reward_calculated to yesterday so automatic system can take over
    UPDATE staked_nfts 
    SET last_reward_calculated = CURRENT_DATE - INTERVAL '1 day'
    WHERE DATE(last_reward_calculated) = CURRENT_DATE;
    
    UPDATE staked_tokens 
    SET last_reward_calculated = CURRENT_DATE - INTERVAL '1 day'
    WHERE DATE(last_reward_calculated) = CURRENT_DATE;
    
    RETURN json_build_object(
        'success', true,
        'message', 'Switched to automatic reward calculation',
        'manual_rewards_deleted', deleted_count,
        'next_automatic_generation', 'Will run automatically at midnight or when users claim'
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| sync_all_user_balances                      | 
DECLARE
  wallet_record RECORD;
  sync_count INTEGER := 0;
BEGIN
  -- Get all unique wallet addresses from reward tables
  FOR wallet_record IN 
    SELECT DISTINCT wallet_address FROM (
      SELECT wallet_address FROM campaign_reward_claims
      UNION
      SELECT wallet_address FROM daily_claims
      UNION
      SELECT wallet_address FROM user_achievements WHERE claimed_at IS NOT NULL
      UNION
      SELECT wallet_address FROM staking_rewards WHERE is_claimed = true
      UNION
      SELECT wallet_address FROM user_balances -- Include existing balances
    ) AS all_wallets
  LOOP
    -- Sync each wallet
    PERFORM sync_user_balance(wallet_record.wallet_address);
    sync_count := sync_count + 1;
  END LOOP;
  
  RETURN 'Synced balances for ' || sync_count || ' wallets';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| sync_all_user_balances_from_all_sources     | 
DECLARE
  wallet_record RECORD;
  sync_count INTEGER := 0;
  error_count INTEGER := 0;
  sync_result TEXT;
BEGIN
  -- Get all unique wallet addresses from all reward tables
  FOR wallet_record IN 
    SELECT DISTINCT wallet_address FROM (
      SELECT wallet_address FROM campaign_reward_claims
      UNION
      SELECT wallet_address FROM daily_claims
      UNION
      SELECT wallet_address FROM user_achievements WHERE claimed_at IS NOT NULL
      UNION
      SELECT wallet_address FROM staking_rewards WHERE is_claimed = true
      UNION
      SELECT wallet_address FROM staked_tokens
      UNION
      SELECT wallet_address FROM user_balances -- Include existing balances
    ) AS all_wallets
    WHERE wallet_address IS NOT NULL AND wallet_address != ''
  LOOP
    -- Sync each wallet
    BEGIN
      sync_result := sync_user_balance_from_all_sources(wallet_record.wallet_address);
      
      IF sync_result LIKE 'SUCCESS:%' THEN
        sync_count := sync_count + 1;
      ELSE
        error_count := error_count + 1;
        RAISE LOG 'Bulk sync failed for %: %', wallet_record.wallet_address, sync_result;
      END IF;
      
    EXCEPTION WHEN OTHERS THEN
      error_count := error_count + 1;
      RAISE LOG 'Exception during bulk sync for %: %', wallet_record.wallet_address, SQLERRM;
    END;
  END LOOP;
  
  RETURN 'Bulk sync complete - Success: ' || sync_count || ', Errors: ' || error_count;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| sync_available_neft                         | 
DECLARE
  affected_wallet TEXT;
  total_staked DECIMAL(18,8);
  current_total DECIMAL(18,8);
  new_available DECIMAL(18,8);
BEGIN
  -- Get the affected wallet address
  IF TG_OP = 'DELETE' THEN
    affected_wallet := OLD.wallet_address;
  ELSE
    affected_wallet := NEW.wallet_address;
  END IF;
  
  -- Calculate total staked for this wallet
  SELECT COALESCE(SUM(amount), 0)
  INTO total_staked
  FROM staked_tokens
  WHERE wallet_address = affected_wallet;
  
  -- Get current total NEFT
  SELECT COALESCE(total_neft_claimed, 0)
  INTO current_total
  FROM user_balances
  WHERE wallet_address = affected_wallet;
  
  -- Calculate new available balance
  new_available := GREATEST(0, current_total - total_staked);
  
  -- Update available_neft in user_balances
  UPDATE user_balances
  SET 
    available_neft = new_available,
    last_updated = NOW()
  WHERE wallet_address = affected_wallet;
  
  RETURN COALESCE(NEW, OLD);
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| sync_claimed_achievements_to_available_neft | 
DECLARE
  wallet_record RECORD;
  achievement_neft DECIMAL(18,8);
  sync_count INTEGER := 0;
BEGIN
  -- Loop through all wallets that have claimed achievements
  FOR wallet_record IN 
    SELECT DISTINCT ua.wallet_address
    FROM user_achievements ua
    WHERE ua.status = 'completed' AND ua.claimed_at IS NOT NULL
  LOOP
    -- Calculate total achievement NEFT for this wallet
    SELECT COALESCE(SUM(am.neft_reward), 0)
    INTO achievement_neft
    FROM user_achievements ua
    JOIN achievements_master am ON ua.achievement_key = am.achievement_key
    WHERE ua.wallet_address = wallet_record.wallet_address
      AND ua.status = 'completed'
      AND ua.claimed_at IS NOT NULL;
    
    -- Update available_neft if there are achievement rewards
    IF achievement_neft > 0 THEN
      -- Use the sync_user_balance function to properly update the balance
      PERFORM sync_user_balance(wallet_record.wallet_address);
      sync_count := sync_count + 1;
    END IF;
  END LOOP;
  
  RETURN 'Synced ' || sync_count || ' wallets with claimed achievement rewards';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| sync_daily_claims_to_user_balances          | 
DECLARE
  claim_record RECORD;
  sync_count INTEGER := 0;
BEGIN
  -- Loop through all daily claims and ensure they're reflected in user_balances
  FOR claim_record IN 
    SELECT 
      wallet_address,
      SUM(base_neft_reward + bonus_neft_reward) as total_neft,
      SUM(base_xp_reward + bonus_xp_reward) as total_xp
    FROM daily_claims 
    GROUP BY wallet_address
  LOOP
    -- Insert or update user_balances
    INSERT INTO user_balances (
      wallet_address, 
      total_neft_claimed, 
      total_xp_earned, 
      available_neft,
      available_xp,
      last_updated
    ) VALUES (
      claim_record.wallet_address, 
      claim_record.total_neft, 
      claim_record.total_xp,
      claim_record.total_neft,
      claim_record.total_xp,
      NOW()
    )
    ON CONFLICT (wallet_address) DO UPDATE SET
      -- Only update if the daily claim totals are higher (to avoid overwriting other sources)
      total_neft_claimed = GREATEST(user_balances.total_neft_claimed, claim_record.total_neft),
      total_xp_earned = GREATEST(user_balances.total_xp_earned, claim_record.total_xp),
      available_neft = GREATEST(user_balances.available_neft, claim_record.total_neft),
      available_xp = GREATEST(user_balances.available_xp, claim_record.total_xp),
      last_updated = NOW();
    
    sync_count := sync_count + 1;
  END LOOP;
  
  RETURN 'Synced ' || sync_count || ' user balances with daily claim data';
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| sync_nft_from_burn                          | 
BEGIN
  INSERT INTO nft_collections (
    nft_id, wallet_address, name, rarity, tier, 
    metadata_uri, created_from
  ) VALUES (
    p_nft_id, p_wallet_address, p_name, p_rarity, p_tier,
    p_metadata_uri, p_created_from
  )
  ON CONFLICT (nft_id) DO UPDATE SET
    wallet_address = EXCLUDED.wallet_address,
    name = EXCLUDED.name,
    rarity = EXCLUDED.rarity,
    tier = EXCLUDED.tier,
    metadata_uri = EXCLUDED.metadata_uri,
    created_from = EXCLUDED.created_from;
  
  RETURN TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RETURN FALSE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| sync_staking_balance                        | 
DECLARE
    total_staked DECIMAL(18,8) := 0;
    current_total_neft DECIMAL(18,8) := 0;
    referral_neft DECIMAL(18,8) := 0;
    new_available DECIMAL(18,8) := 0;
BEGIN
    -- Calculate total staked amount for the wallet
    SELECT COALESCE(SUM(amount), 0) INTO total_staked
    FROM staked_tokens 
    WHERE wallet_address = COALESCE(NEW.wallet_address, OLD.wallet_address);
    
    -- Get current total NEFT claimed
    SELECT COALESCE(total_neft_claimed, 0) INTO current_total_neft
    FROM user_balances 
    WHERE wallet_address = COALESCE(NEW.wallet_address, OLD.wallet_address);
    
    -- Get referral earnings
    SELECT COALESCE(total_neft_earned, 0) INTO referral_neft
    FROM user_referrals 
    WHERE wallet_address = COALESCE(NEW.wallet_address, OLD.wallet_address);
    
    -- Calculate new available amount
    new_available := GREATEST(0, (current_total_neft + referral_neft) - total_staked);
    
    -- Update user_balances with new available_neft
    INSERT INTO user_balances (wallet_address, total_neft_claimed, available_neft, total_xp_earned, last_updated)
    VALUES (
        COALESCE(NEW.wallet_address, OLD.wallet_address), 
        current_total_neft, 
        new_available, 
        0, 
        NOW()
    )
    ON CONFLICT (wallet_address) 
    DO UPDATE SET 
        available_neft = new_available,
        last_updated = NOW();
    
    RETURN COALESCE(NEW, OLD);
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| sync_staking_balance                        | 
DECLARE
  total_staked NUMERIC(18,8) := 0;
BEGIN
  -- Calculate total staked amount
  SELECT COALESCE(SUM(amount), 0)
  INTO total_staked
  FROM staked_tokens
  WHERE wallet_address = user_wallet;
  
  -- Update user_balances table with current staked amount
  UPDATE user_balances 
  SET last_updated = NOW()
  WHERE wallet_address = user_wallet;
  
  -- Insert if user doesn't exist
  INSERT INTO user_balances (wallet_address, last_updated)
  VALUES (user_wallet, NOW())
  ON CONFLICT (wallet_address) DO NOTHING;
  
  RETURN TRUE;
EXCEPTION
  WHEN OTHERS THEN
    RETURN FALSE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| sync_user_balance                           | 
DECLARE
  balance_data JSON;
  total_neft DECIMAL(18,8);
  total_xp INTEGER;
  available_neft DECIMAL(18,8);
BEGIN
  -- Get aggregated balance data
  balance_data := get_user_complete_balance(user_wallet);
  
  -- Extract values from JSON
  total_neft := (balance_data->>'total_neft')::DECIMAL(18,8);
  total_xp := (balance_data->>'total_xp')::INTEGER;
  available_neft := (balance_data->>'available_neft')::DECIMAL(18,8);
  
  -- Insert or update user_balances table
  INSERT INTO user_balances (
    wallet_address,
    total_neft_claimed,
    total_xp_earned,
    available_neft,
    last_updated
  ) VALUES (
    user_wallet,
    total_neft,
    total_xp,
    available_neft,
    NOW()
  )
  ON CONFLICT (wallet_address) 
  DO UPDATE SET
    total_neft_claimed = EXCLUDED.total_neft_claimed,
    total_xp_earned = EXCLUDED.total_xp_earned,
    available_neft = EXCLUDED.available_neft,
    last_updated = NOW();
    
  RETURN 'Synced balance for wallet: ' || user_wallet || ' - NEFT: ' || total_neft || ', XP: ' || total_xp;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| sync_user_balance_from_all_sources          | 
DECLARE
  aggregated_data JSON;
  total_neft DECIMAL(18,8);
  total_xp INTEGER;
  available_neft DECIMAL(18,8);
  sync_result TEXT;
BEGIN
  -- Validate input
  IF user_wallet IS NULL OR user_wallet = '' THEN
    RETURN 'ERROR: user_wallet parameter cannot be null or empty';
  END IF;

  -- Get aggregated data from all reward sources
  BEGIN
    aggregated_data := aggregate_user_rewards_from_all_sources(user_wallet);
    
    -- Check if aggregation returned an error
    IF aggregated_data->>'error' IS NOT NULL THEN
      RETURN 'ERROR in aggregation: ' || (aggregated_data->>'error');
    END IF;
    
  EXCEPTION WHEN OTHERS THEN
    RETURN 'ERROR calling aggregation function: ' || SQLERRM;
  END;
  
  -- Extract values from JSON with proper error handling
  BEGIN
    total_neft := COALESCE((aggregated_data->>'total_neft_claimed')::DECIMAL(18,8), 0);
    total_xp := COALESCE((aggregated_data->>'total_xp_earned')::INTEGER, 0);
    available_neft := COALESCE((aggregated_data->>'available_neft')::DECIMAL(18,8), 0);
  EXCEPTION WHEN OTHERS THEN
    RETURN 'ERROR parsing aggregated data: ' || SQLERRM;
  END;
  
  -- Insert or update user_balances table with aggregated data
  BEGIN
    INSERT INTO user_balances (
      wallet_address,
      total_neft_claimed,
      total_xp_earned,
      available_neft,
      last_updated
    ) VALUES (
      user_wallet,
      total_neft,
      total_xp,
      available_neft,
      NOW()
    )
    ON CONFLICT (wallet_address) 
    DO UPDATE SET
      total_neft_claimed = EXCLUDED.total_neft_claimed,
      total_xp_earned = EXCLUDED.total_xp_earned,
      available_neft = EXCLUDED.available_neft,
      last_updated = NOW();
      
    sync_result := 'SUCCESS: Synced balance for wallet: ' || user_wallet || 
                   ' - NEFT: ' || total_neft || 
                   ', XP: ' || total_xp || 
                   ', Available: ' || available_neft;
                   
  EXCEPTION WHEN OTHERS THEN
    sync_result := 'ERROR updating user_balances: ' || SQLERRM;
  END;
    
  RETURN sync_result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| test_generate_rewards_for_user              | 
DECLARE
    result JSON;
    staking_count INTEGER;
BEGIN
    -- Check if user has any staked items
    SELECT 
        (SELECT COUNT(*) FROM staked_nfts WHERE wallet_address = user_wallet) +
        (SELECT COUNT(*) FROM staked_tokens WHERE wallet_address = user_wallet)
    INTO staking_count;
    
    IF staking_count = 0 THEN
        RETURN json_build_object(
            'success', false,
            'message', 'No staked items found for this user',
            'staked_items_count', staking_count
        );
    END IF;
    
    -- Generate rewards
    SELECT generate_user_daily_rewards(user_wallet) INTO result;
    
    RETURN json_build_object(
        'success', true,
        'message', 'Reward generation completed',
        'staked_items_count', staking_count,
        'generation_result', result
    );
    
EXCEPTION
    WHEN OTHERS THEN
        RETURN json_build_object(
            'success', false,
            'error', SQLERRM,
            'message', 'Error during reward generation test'
        );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| test_staking_achievement                    | 
DECLARE
  result RECORD;
BEGIN
  -- Update first_stake achievement
  SELECT * INTO result
  FROM update_achievement_progress(user_wallet, 'first_stake', 1);
  
  RETURN QUERY SELECT 
    'first_stake'::TEXT,
    GREATEST(0, result.new_progress - 1),
    result.new_progress,
    result.required_count,
    result.achievement_completed;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| trigger_balance_sync                        | 
BEGIN
  -- Sync the user's balance when any reward is added/updated
  PERFORM sync_user_balance(NEW.wallet_address);
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| trigger_comprehensive_balance_sync          | 
DECLARE
  sync_result TEXT;
  target_wallet TEXT;
BEGIN
  -- Determine the wallet address from the trigger
  IF TG_OP = 'DELETE' THEN
    target_wallet := OLD.wallet_address;
  ELSE
    target_wallet := NEW.wallet_address;
  END IF;
  
  -- Sync the user's balance when any reward is added/updated/deleted
  BEGIN
    sync_result := sync_user_balance_from_all_sources(target_wallet);
    
    -- Log the sync result for debugging
    RAISE LOG 'Comprehensive balance sync for % (table: %, op: %): %', 
      target_wallet, TG_TABLE_NAME, TG_OP, sync_result;
    
  EXCEPTION WHEN OTHERS THEN
    -- Log error but don't fail the original transaction
    RAISE LOG 'Comprehensive balance sync failed for % (table: %, op: %): %', 
      target_wallet, TG_TABLE_NAME, TG_OP, SQLERRM;
  END;
  
  -- Return appropriate record based on operation
  IF TG_OP = 'DELETE' THEN
    RETURN OLD;
  ELSE
    RETURN NEW;
  END IF;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| trigger_update_user_level                   | 
BEGIN
    -- Update level based on new total_xp_earned
    NEW.current_level := calculate_level_from_xp(COALESCE(NEW.total_xp_earned, 0));
    NEW.last_updated := NOW();
    RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| unlink_account_from_user                    | 
BEGIN
  IF account_type = 'wallet' THEN
    UPDATE users 
    SET linked_wallet_addresses = linked_wallet_addresses - account_id
    WHERE wallet_address = user_wallet_address;
  ELSIF account_type = 'social' THEN
    UPDATE users 
    SET linked_social_accounts = linked_social_accounts - account_id
    WHERE wallet_address = user_wallet_address;
  END IF;
  
  RETURN TRUE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| unstake_neft_tokens                         | 
DECLARE
    current_staked_amount DECIMAL(18,8);
    actual_unstake_amount DECIMAL(18,8);
    remaining_amount DECIMAL(18,8);
BEGIN
    SELECT amount INTO current_staked_amount
    FROM staked_tokens 
    WHERE id = staked_tokens_id AND wallet_address = user_wallet;
    
    IF NOT FOUND THEN
        RETURN json_build_object('success', false, 'error', 'Staked tokens not found');
    END IF;
    
    actual_unstake_amount := LEAST(unstake_amount, current_staked_amount);
    
    -- Update user balance (add back unstaked amount)
    UPDATE user_balances 
    SET available_neft = available_neft + actual_unstake_amount,
        last_updated = NOW()
    WHERE wallet_address = user_wallet;
    
    IF actual_unstake_amount >= current_staked_amount THEN
        DELETE FROM staked_tokens WHERE id = staked_tokens_id;
    ELSE
        remaining_amount := current_staked_amount - actual_unstake_amount;
        UPDATE staked_tokens 
        SET amount = remaining_amount,
            daily_reward = (remaining_amount * 20.00 / 100) / 365
        WHERE id = staked_tokens_id;
    END IF;
    
    RETURN json_build_object('success', true, 'message', format('Successfully unstaked %s NEFT', actual_unstake_amount));
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| unstake_nft                                 | 
BEGIN
    DELETE FROM staked_nfts 
    WHERE id = staked_nft_id AND wallet_address = user_wallet;
    
    IF NOT FOUND THEN
        RETURN json_build_object('success', false, 'error', 'NFT not found or not owned by user');
    END IF;
    
    RETURN json_build_object('success', true, 'message', 'NFT unstaked successfully');
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| update_achievement_progress                 | 
DECLARE
  current_progress_val INTEGER;
  required_count_val INTEGER;
  achievement_completed_val BOOLEAN := FALSE;
BEGIN
  -- Initialize user achievements if needed
  PERFORM initialize_user_achievements(user_wallet);
  
  -- Get current progress and required count
  SELECT ua.current_progress, am.required_count
  INTO current_progress_val, required_count_val
  FROM user_achievements ua
  JOIN achievements_master am ON ua.achievement_key = am.achievement_key
  WHERE ua.wallet_address = user_wallet AND ua.achievement_key = achievement_key_param;
  
  -- If no record exists, create one
  IF current_progress_val IS NULL THEN
    SELECT required_count INTO required_count_val
    FROM achievements_master 
    WHERE achievement_key = achievement_key_param AND is_active = TRUE;
    
    IF required_count_val IS NULL THEN
      RAISE EXCEPTION 'Achievement not found: %', achievement_key_param;
    END IF;
    
    INSERT INTO user_achievements (wallet_address, achievement_key, current_progress, status)
    VALUES (user_wallet, achievement_key_param, 0, 'locked'::achievement_status);
    
    current_progress_val := 0;
  END IF;
  
  -- Update progress
  current_progress_val := current_progress_val + progress_increment;
  
  -- Check if completed
  achievement_completed_val := current_progress_val >= required_count_val;
  
  -- Update the record
  UPDATE user_achievements SET
    current_progress = current_progress_val,
    status = CASE 
      WHEN current_progress_val >= required_count_val THEN 'completed'::achievement_status
      WHEN current_progress_val > 0 THEN 'in_progress'::achievement_status
      ELSE 'locked'::achievement_status
    END,
    completed_at = CASE 
      WHEN current_progress_val >= required_count_val AND completed_at IS NULL THEN NOW()
      ELSE completed_at
    END,
    updated_at = NOW()
  WHERE wallet_address = user_wallet AND achievement_key = achievement_key_param;
  
  RETURN QUERY SELECT achievement_completed_val, current_progress_val, required_count_val;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| update_activity_stats_trigger               | 
BEGIN
  -- This is handled by the log_user_activity function
  -- But we can add additional logic here if needed
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| update_all_pending_rewards                  | 
DECLARE
    users_updated INTEGER := 0;
    current_time TIMESTAMP WITH TIME ZONE := NOW();
BEGIN
    -- Update pending rewards for all users with staked assets (using working pattern)
    WITH all_users AS (
        SELECT DISTINCT wallet_address FROM staked_nfts
        UNION
        SELECT DISTINCT wallet_address FROM staked_tokens
    ),
    nft_rewards AS (
        SELECT 
            wallet_address,
            COALESCE(SUM(
                daily_reward * LEAST(1.0, EXTRACT(EPOCH FROM (NOW() - staked_at)) / 86400.0)
            ), 0) as nft_pending
        FROM staked_nfts
        GROUP BY wallet_address
    ),
    token_rewards AS (
        SELECT 
            wallet_address,
            COALESCE(SUM(
                daily_reward * LEAST(1.0, EXTRACT(EPOCH FROM (NOW() - staked_at)) / 86400.0)
            ), 0) as token_pending
        FROM staked_tokens
        GROUP BY wallet_address
    ),
    user_rewards AS (
        SELECT 
            u.wallet_address,
            COALESCE(n.nft_pending, 0) as nft_pending,
            COALESCE(t.token_pending, 0) as token_pending
        FROM all_users u
        LEFT JOIN nft_rewards n ON u.wallet_address = n.wallet_address
        LEFT JOIN token_rewards t ON u.wallet_address = t.wallet_address
    )
    INSERT INTO user_pending_rewards (wallet_address, nft_pending_rewards, token_pending_rewards, total_pending_rewards, last_updated)
    SELECT 
        wallet_address,
        nft_pending,
        token_pending,
        nft_pending + token_pending,
        NOW()
    FROM user_rewards
    ON CONFLICT (wallet_address) 
    DO UPDATE SET 
        nft_pending_rewards = EXCLUDED.nft_pending_rewards,
        token_pending_rewards = EXCLUDED.token_pending_rewards,
        total_pending_rewards = EXCLUDED.total_pending_rewards,
        last_updated = EXCLUDED.last_updated;
    
    GET DIAGNOSTICS users_updated = ROW_COUNT;
    
    RETURN json_build_object(
        'success', true,
        'timestamp', current_time,
        'users_updated', users_updated,
        'message', format('Updated pending rewards for %s users', users_updated)
    );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| update_burn_transactions_updated_at         | 
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| update_participation_stats                  | 
BEGIN
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        UPDATE user_participations 
        SET 
            completed_tasks_count = (
                SELECT COUNT(*) FROM user_task_completions 
                WHERE project_id = NEW.project_id AND wallet_address = NEW.wallet_address AND completed = true
            ),
            total_tasks_count = (
                SELECT COUNT(*) FROM project_tasks 
                WHERE project_id = NEW.project_id AND is_active = true
            ),
            updated_at = NOW()
        WHERE project_id = NEW.project_id AND wallet_address = NEW.wallet_address;
        
        UPDATE user_participations 
        SET completion_percentage = CASE 
            WHEN total_tasks_count > 0 THEN (completed_tasks_count::DECIMAL / total_tasks_count * 100)
            ELSE 0 
        END
        WHERE project_id = NEW.project_id AND wallet_address = NEW.wallet_address;
        
        RETURN NEW;
    END IF;
    RETURN NULL;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| update_project_participants                 | 
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE projects 
        SET current_participants = (
            SELECT COUNT(DISTINCT wallet_address) 
            FROM user_participations 
            WHERE project_id = NEW.project_id
        )
        WHERE id = NEW.project_id;
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        UPDATE projects 
        SET current_participants = (
            SELECT COUNT(DISTINCT wallet_address) 
            FROM user_participations 
            WHERE project_id = OLD.project_id
        )
        WHERE id = OLD.project_id;
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| update_referral_stats                       | 
BEGIN
  UPDATE public.user_referrals
  SET 
    total_referrals = total_referrals + 1,
    total_neft_earned = total_neft_earned + COALESCE(p_neft_reward, 0),
    updated_at = NOW()
  WHERE wallet_address = p_wallet_address;

  -- Create profile if doesn't exist
  IF NOT FOUND THEN
    INSERT INTO public.user_referrals (wallet_address, referral_code, total_referrals, total_neft_earned)
    VALUES (
      p_wallet_address,
      'NEFT-' || UPPER(SUBSTRING(MD5(gen_random_uuid()::TEXT) FROM 1 FOR 8)),
      1,
      COALESCE(p_neft_reward, 0)
    );
  END IF;
END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| update_referral_stats                       | 
BEGIN
    -- Update user_referrals with both NEFT and XP totals
    UPDATE user_referrals SET
        total_neft_earned = total_neft_earned + neft_amount,
        total_xp_earned = total_xp_earned + xp_amount,
        updated_at = NOW()
    WHERE wallet_address = user_wallet;
    
    RETURN TRUE;
EXCEPTION
    WHEN OTHERS THEN
        RETURN FALSE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| update_staking_balance                      | 
DECLARE
    current_total_neft DECIMAL(18,8) := 0;
    current_available_neft DECIMAL(18,8) := 0;
    current_staked_amount DECIMAL(18,8) := 0;
    new_available_neft DECIMAL(18,8) := 0;
    referral_neft DECIMAL(18,8) := 0;
BEGIN
    -- Validate operation
    IF operation NOT IN ('stake', 'unstake') THEN
        RAISE EXCEPTION 'Invalid operation. Must be "stake" or "unstake"';
    END IF;

    -- Validate amount
    IF stake_amount <= 0 THEN
        RAISE EXCEPTION 'Amount must be greater than 0';
    END IF;

    -- Get current user balance
    SELECT 
        COALESCE(total_neft_claimed, 0),
        COALESCE(available_neft, 0)
    INTO current_total_neft, current_available_neft
    FROM user_balances 
    WHERE wallet_address = user_wallet;

    -- Get referral earnings
    SELECT COALESCE(total_neft_earned, 0)
    INTO referral_neft
    FROM user_referrals 
    WHERE wallet_address = user_wallet;

    -- Get current staked amount
    SELECT COALESCE(SUM(amount), 0)
    INTO current_staked_amount
    FROM staked_tokens 
    WHERE wallet_address = user_wallet;

    -- Calculate total NEFT including referrals
    current_total_neft := current_total_neft + referral_neft;

    -- Perform operation
    IF operation = 'stake' THEN
        -- Validate sufficient available balance
        IF current_available_neft < stake_amount THEN
            RAISE EXCEPTION 'Insufficient available balance. Available: %, Required: %', 
                current_available_neft, stake_amount;
        END IF;
        
        -- Calculate new available amount after staking
        new_available_neft := current_available_neft - stake_amount;
        
    ELSE -- unstake
        -- Calculate new available amount after unstaking
        new_available_neft := current_available_neft + stake_amount;
        
        -- Ensure we don't exceed total claimed amount
        IF new_available_neft > current_total_neft THEN
            new_available_neft := current_total_neft;
        END IF;
    END IF;

    -- Update user_balances table with new available_neft
    INSERT INTO user_balances (wallet_address, total_neft_claimed, available_neft, total_xp_earned, last_updated)
    VALUES (user_wallet, current_total_neft - referral_neft, new_available_neft, 0, NOW())
    ON CONFLICT (wallet_address) 
    DO UPDATE SET 
        available_neft = new_available_neft,
        last_updated = NOW();

    -- Return success result
    RETURN json_build_object(
        'success', true,
        'operation', operation,
        'amount', stake_amount,
        'previous_available', current_available_neft,
        'new_available', new_available_neft,
        'total_neft', current_total_neft
    );

EXCEPTION
    WHEN OTHERS THEN
        RETURN json_build_object(
            'success', false,
            'error', SQLERRM,
            'operation', operation,
            'amount', stake_amount
        );
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| update_updated_at_column                    | 
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| update_user_balance_after_claim             | 
BEGIN
  -- Insert or update user balance
  INSERT INTO user_balances (wallet_address, total_neft_claimed, total_xp_earned)
  VALUES (NEW.wallet_address, NEW.neft_reward, NEW.xp_reward)
  ON CONFLICT (wallet_address)
  DO UPDATE SET
    total_neft_claimed = user_balances.total_neft_claimed + NEW.neft_reward,
    total_xp_earned = user_balances.total_xp_earned + NEW.xp_reward,
    last_updated = NOW();
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| update_user_balance_after_daily_claim       | 
BEGIN
  -- Insert or update user balance with daily claim rewards
  INSERT INTO user_balances (wallet_address, total_neft_claimed, total_xp_earned)
  VALUES (NEW.wallet_address, NEW.total_neft_reward, NEW.total_xp_reward)
  ON CONFLICT (wallet_address)
  DO UPDATE SET
    total_neft_claimed = user_balances.total_neft_claimed + NEW.total_neft_reward,
    total_xp_earned = user_balances.total_xp_earned + NEW.total_xp_reward,
    last_updated = NOW();
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| update_user_level                           | 
DECLARE
    user_xp NUMERIC;
    calculated_level INTEGER;
BEGIN
    -- Get current total XP for user
    SELECT COALESCE(total_xp_earned, 0) INTO user_xp
    FROM user_balances 
    WHERE wallet_address = user_wallet;
    
    -- Calculate level from XP
    calculated_level := calculate_level_from_xp(user_xp);
    
    -- Update user's level
    UPDATE user_balances 
    SET current_level = calculated_level,
        last_updated = NOW()
    WHERE wallet_address = user_wallet;
    
    -- Insert record if user doesn't exist
    IF NOT FOUND THEN
        INSERT INTO user_balances (
            wallet_address, 
            current_level, 
            total_xp_earned, 
            last_updated
        ) VALUES (
            user_wallet, 
            calculated_level, 
            0, 
            NOW()
        );
    END IF;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| update_user_stats                           | 
BEGIN
  -- Update user's last active timestamp
  UPDATE users 
  SET 
    last_active = NOW(),
    updated_at = NOW()
  WHERE id = NEW.user_id;
  
  RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| upsert_user                                 | 
begin
  insert into public.users (
    wallet_address, email, provider, display_name, avatar_url,
    wallet_type, metadata, social_provider, last_login, updated_at
  )
  values (
    in_wallet_address, in_email, in_provider, in_display_name, in_avatar_url,
    in_wallet_type, in_metadata, in_social_provider, now(), now()
  )
  on conflict (wallet_address)
  do update set
    email = coalesce(excluded.email, users.email),
    provider = coalesce(excluded.provider, users.provider),
    display_name = coalesce(excluded.display_name, users.display_name),
    avatar_url = coalesce(excluded.avatar_url, users.avatar_url),
    wallet_type = coalesce(excluded.wallet_type, users.wallet_type),
    metadata = coalesce(excluded.metadata, users.metadata),
    social_provider = coalesce(excluded.social_provider, users.social_provider),
    last_login = now(),
    updated_at = now();
end;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| upsert_user                                 | 
BEGIN
  RETURN QUERY
  INSERT INTO public.users (
    wallet_address, email, display_name, avatar_url, provider, social_provider, wallet_type, metadata, 
    linked_wallet_address, linked_social_accounts, last_login, updated_at
  ) VALUES (
    in_wallet_address, in_email, in_display_name, in_avatar_url, in_provider, in_social_provider, in_wallet_type, in_metadata,
    COALESCE(in_linked_wallet_address, '[]'::jsonb), COALESCE(in_linked_social_accounts, '[]'::jsonb), now(), now()
  )
  ON CONFLICT (wallet_address) DO UPDATE
    SET email = excluded.email,
        display_name = excluded.display_name,
        avatar_url = excluded.avatar_url,
        provider = excluded.provider,
        social_provider = excluded.social_provider,
        wallet_type = excluded.wallet_type,
        metadata = excluded.metadata,
        linked_wallet_address = CASE
          WHEN in_linked_wallet_address IS NOT NULL THEN excluded.linked_wallet_address
          ELSE public.users.linked_wallet_address
        END,
        linked_social_accounts = CASE
          WHEN in_linked_social_accounts IS NOT NULL THEN excluded.linked_social_accounts
          ELSE public.users.linked_social_accounts
        END,
        last_login = now(),
        updated_at = now()
  RETURNING 
    id,
    wallet_address,
    email,
    display_name,
    avatar_url,
    provider,
    social_provider,
    wallet_type,
    metadata,
    linked_wallet_address,
    linked_social_accounts,
    created_at,
    last_login,
    updated_at;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| upsert_user_enhanced                        | 
DECLARE
  user_record RECORD;
  new_linked_wallets jsonb;
  new_linked_socials jsonb;
  operation_type text := 'upsert';
BEGIN
  -- Check if linking a wallet
  IF in_link_wallet IS NOT NULL THEN
    -- Prevent duplicate wallet linking
    IF public.is_wallet_already_linked(in_link_wallet) THEN
      RAISE EXCEPTION 'Wallet % is already linked to another account', in_link_wallet;
    END IF;
    
    -- Find user and add wallet to linked_wallet_addresses
    UPDATE public.users 
    SET linked_wallet_addresses = linked_wallet_addresses || jsonb_build_array(in_link_wallet),
        last_login = now(),
        updated_at = now()
    WHERE wallet_address = in_wallet_address
    RETURNING * INTO user_record;
    
    operation_type := 'link_wallet';
  END IF;
  
  -- Check if linking a social account
  IF in_link_social_provider IS NOT NULL AND in_link_social_id IS NOT NULL THEN
    -- Prevent duplicate social linking
    IF public.is_social_already_linked(in_link_social_provider, in_link_social_id) THEN
      RAISE EXCEPTION 'Social account %:% is already linked to another account', in_link_social_provider, in_link_social_id;
    END IF;
    
    -- Find user and add social to linked_social_accounts
    UPDATE public.users 
    SET linked_social_accounts = linked_social_accounts || jsonb_build_array(
      jsonb_build_object('provider', in_link_social_provider, 'id', in_link_social_id)
    ),
    last_login = now(),
    updated_at = now()
    WHERE wallet_address = in_wallet_address
    RETURNING * INTO user_record;
    
    operation_type := 'link_social';
  END IF;
  
  -- Regular upsert operation
  IF in_link_wallet IS NULL AND (in_link_social_provider IS NULL OR in_link_social_id IS NULL) THEN
    -- Standard upsert with last_login update
    INSERT INTO public.users (
      wallet_address, email, display_name, avatar_url, provider, social_provider, 
      wallet_type, metadata, last_login, updated_at
    ) VALUES (
      in_wallet_address, in_email, in_display_name, in_avatar_url, in_provider, 
      in_social_provider, in_wallet_type, in_metadata, now(), now()
    )
    ON CONFLICT (wallet_address) DO UPDATE
      SET email = EXCLUDED.email,
          display_name = EXCLUDED.display_name,
          avatar_url = EXCLUDED.avatar_url,
          provider = EXCLUDED.provider,
          social_provider = EXCLUDED.social_provider,
          wallet_type = EXCLUDED.wallet_type,
          metadata = EXCLUDED.metadata,
          last_login = now(),
          updated_at = now()
    RETURNING * INTO user_record;
  END IF;
  
  -- Return the user record
  RETURN QUERY
  SELECT user_record.id, user_record.wallet_address, user_record.email, 
         user_record.display_name, user_record.avatar_url, user_record.provider,
         user_record.social_provider, user_record.wallet_type, user_record.metadata,
         user_record.linked_wallet_addresses, user_record.linked_social_accounts,
         user_record.created_at, user_record.last_login, user_record.updated_at,
         operation_type;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| use_burn_chance                             | 
DECLARE
  chance_id UUID;
BEGIN
  -- Get the oldest unused burn chance
  SELECT id INTO chance_id
  FROM user_burn_chances
  WHERE wallet_address = p_wallet_address 
    AND used_at IS NULL
  ORDER BY earned_at ASC
  LIMIT 1;
  
  IF chance_id IS NULL THEN
    RETURN FALSE;
  END IF;
  
  -- Mark the burn chance as used
  UPDATE user_burn_chances
  SET used_at = NOW()
  WHERE id = chance_id;
  
  RETURN TRUE;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| validate_burn_operation                     | 
DECLARE
    nft_count INTEGER;
    rarity_check BOOLEAN;
    ownership_check BOOLEAN;
BEGIN
    -- Check if all NFTs exist and are owned by the wallet
    SELECT COUNT(*) INTO nft_count
    FROM nfts n
    WHERE n.id = ANY(nft_ids)
    AND n.owner_wallet = wallet_addr
    AND n.claimed = false;
    
    -- Check if we have the right number of NFTs
    IF nft_count != array_length(nft_ids, 1) THEN
        RETURN QUERY SELECT false, 'Some NFTs are not owned by this wallet or already claimed';
        RETURN;
    END IF;
    
    -- Check if we have the required amount
    IF nft_count != required_amount THEN
        RETURN QUERY SELECT false, format('Expected %s NFTs, but got %s', required_amount, nft_count);
        RETURN;
    END IF;
    
    -- Check if all NFTs have the same rarity
    SELECT COUNT(DISTINCT n.rarity) = 1 AND MIN(n.rarity) = expected_rarity INTO rarity_check
    FROM nfts n
    WHERE n.id = ANY(nft_ids);
    
    IF NOT rarity_check THEN
        RETURN QUERY SELECT false, format('All NFTs must be of %s rarity', expected_rarity);
        RETURN;
    END IF;
    
    -- All checks passed
    RETURN QUERY SELECT true, 'Validation successful'::TEXT;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| validate_corrected_staking_system           | 
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'system_status', 'Corrected fresh staking system deployed',
        'reward_rates', json_build_object(
            'Common', 0.1,
            'Rare', 0.4,
            'Legendary', 1.0,
            'Platinum', 2.5,
            'Silver', 8.0,
            'Gold', 30.0
        ),
        'token_apr', '20% annual (default)',
        'calculation_method', 'Real-time based on staking duration',
        'user_balance_integration', 'Claimed rewards added to available_neft',
        'egress_optimization', 'Single RPC call for all data'
    ) INTO result;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| validate_fresh_staking_system               | 
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'tables_created', json_build_object(
            'staked_nfts', (SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'staked_nfts') > 0,
            'staked_tokens', (SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'staked_tokens') > 0
        ),
        'functions_available', json_build_object(
            'stake_nft', (SELECT COUNT(*) FROM pg_proc WHERE proname = 'stake_nft') > 0,
            'unstake_nft', (SELECT COUNT(*) FROM pg_proc WHERE proname = 'unstake_nft') > 0,
            'stake_neft_tokens', (SELECT COUNT(*) FROM pg_proc WHERE proname = 'stake_neft_tokens') > 0,
            'unstake_neft_tokens', (SELECT COUNT(*) FROM pg_proc WHERE proname = 'unstake_neft_tokens') > 0,
            'get_user_staking_summary', (SELECT COUNT(*) FROM pg_proc WHERE proname = 'get_user_staking_summary') > 0,
            'claim_staking_rewards', (SELECT COUNT(*) FROM pg_proc WHERE proname = 'claim_staking_rewards') > 0
        ),
        'schema_consistency', json_build_object(
            'nft_daily_reward_precision', (SELECT numeric_precision FROM information_schema.columns WHERE table_name = 'staked_nfts' AND column_name = 'daily_reward'),
            'token_daily_reward_precision', (SELECT numeric_precision FROM information_schema.columns WHERE table_name = 'staked_tokens' AND column_name = 'daily_reward')
        ),
        'system_status', 'Fresh staking system ready - ultra low egress design'
    ) INTO result;
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| validate_migration_success                  | 
DECLARE
    result JSON;
    nft_precision INTEGER;
    token_precision INTEGER;
    reward_precision INTEGER;
    nft_count INTEGER;
    token_count INTEGER;
    reward_count INTEGER;
BEGIN
    -- Check precision consistency
    SELECT numeric_precision INTO nft_precision
    FROM information_schema.columns 
    WHERE table_name = 'staked_nfts' AND column_name = 'daily_reward';
    
    SELECT numeric_precision INTO token_precision
    FROM information_schema.columns 
    WHERE table_name = 'staked_tokens' AND column_name = 'daily_reward';
    
    SELECT numeric_precision INTO reward_precision
    FROM information_schema.columns 
    WHERE table_name = 'staking_rewards' AND column_name = 'reward_amount';
    
    -- Check data integrity
    SELECT COUNT(*) INTO nft_count FROM staked_nfts WHERE daily_reward > 0;
    SELECT COUNT(*) INTO token_count FROM staked_tokens WHERE daily_reward > 0;
    SELECT COUNT(*) INTO reward_count FROM staking_rewards;
    
    result := json_build_object(
        'migration_successful', (nft_precision = 18 AND token_precision = 18 AND reward_precision = 18),
        'precision_consistency', json_build_object(
            'nft_daily_reward', nft_precision,
            'token_daily_reward', token_precision,
            'reward_amount', reward_precision
        ),
        'data_integrity', json_build_object(
            'nfts_with_rewards', nft_count,
            'tokens_with_rewards', token_count,
            'total_reward_records', reward_count
        ),
        'functions_available', json_build_object(
            'get_user_staking_summary', (SELECT COUNT(*) FROM pg_proc WHERE proname = 'get_user_staking_summary') > 0,
            'debug_user_staking_data', (SELECT COUNT(*) FROM pg_proc WHERE proname = 'debug_user_staking_data') > 0
        ),
        'recommendations', CASE 
            WHEN nft_precision != 18 OR token_precision != 18 OR reward_precision != 18 
            THEN 'Migration incomplete - precision issues remain'
            ELSE 'Migration successful - schema is now consistent'
        END
    );
    
    RETURN result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| validate_referral_code                      | 
  SELECT ur.wallet_address, TRUE as is_valid
  FROM public.user_referrals ur
  WHERE ur.referral_code = p_code
  LIMIT 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| validate_staking_operation                  | 
DECLARE
    available_balance DECIMAL(18,8) := 0;
    staked_amount DECIMAL(18,8) := 0;
    pending_rewards DECIMAL(18,8) := 0;
    validation_result JSON;
BEGIN
    -- Get current balances
    SELECT 
        COALESCE(available_neft, 0),
        COALESCE((SELECT SUM(amount) FROM staked_tokens WHERE wallet_address = user_wallet), 0),
        COALESCE((SELECT SUM(reward_amount) FROM staking_rewards WHERE wallet_address = user_wallet AND is_claimed = false), 0)
    INTO available_balance, staked_amount, pending_rewards
    FROM user_balances 
    WHERE wallet_address = user_wallet;
    
    -- Validate based on operation
    CASE operation
        WHEN 'stake' THEN
            IF amount IS NULL OR amount <= 0 THEN
                validation_result := json_build_object(
                    'valid', false,
                    'error', 'Invalid stake amount'
                );
            ELSIF available_balance < amount THEN
                validation_result := json_build_object(
                    'valid', false,
                    'error', format('Insufficient balance. Available: %s, Required: %s', available_balance, amount)
                );
            ELSE
                validation_result := json_build_object(
                    'valid', true,
                    'available_balance', available_balance,
                    'stake_amount', amount
                );
            END IF;
            
        WHEN 'unstake' THEN
            IF asset_id IS NULL THEN
                validation_result := json_build_object(
                    'valid', false,
                    'error', 'Asset ID required for unstaking'
                );
            ELSE
                -- Check if asset exists and belongs to user
                IF NOT EXISTS (SELECT 1 FROM staked_tokens WHERE id = asset_id AND wallet_address = user_wallet) THEN
                    validation_result := json_build_object(
                        'valid', false,
                        'error', 'Staked asset not found or access denied'
                    );
                ELSE
                    validation_result := json_build_object(
                        'valid', true,
                        'staked_amount', staked_amount
                    );
                END IF;
            END IF;
            
        WHEN 'claim' THEN
            IF pending_rewards <= 0 THEN
                validation_result := json_build_object(
                    'valid', false,
                    'error', 'No rewards available to claim'
                );
            ELSE
                validation_result := json_build_object(
                    'valid', true,
                    'pending_rewards', pending_rewards
                );
            END IF;
            
        ELSE
            validation_result := json_build_object(
                'valid', false,
                'error', 'Invalid operation type'
            );
    END CASE;
    
    RETURN validation_result;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| validate_task_configuration                 | 
BEGIN
    IF NEW.type = 'twitter_follow' AND NEW.twitter_username IS NULL THEN
        RAISE EXCEPTION 'twitter_username is required for twitter_follow tasks';
    END IF;
    
    IF NEW.type = 'twitter_retweet' AND NEW.twitter_tweet_id IS NULL THEN
        RAISE EXCEPTION 'twitter_tweet_id is required for twitter_retweet tasks';
    END IF;
    
    IF NEW.type = 'discord_role' AND (NEW.discord_guild_id IS NULL OR NEW.required_role_id IS NULL) THEN
        RAISE EXCEPTION 'discord_guild_id and required_role_id are required for discord_role tasks';
    END IF;
    
    IF NEW.type = 'telegram_join' AND NEW.telegram_channel_id IS NULL THEN
        RAISE EXCEPTION 'telegram_channel_id is required for telegram_join tasks';
    END IF;
    
    IF NEW.type = 'visit_website' AND NEW.website_url IS NULL THEN
        RAISE EXCEPTION 'website_url is required for visit_website tasks';
    END IF;
    
    IF NEW.type = 'quiz' AND (NEW.quiz_questions IS NULL OR jsonb_array_length(NEW.quiz_questions) = 0) THEN
        RAISE EXCEPTION 'quiz_questions array is required for quiz tasks';
    END IF;
    
    RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| validate_token_staking                      | 
DECLARE
    available_balance DECIMAL(18,8);
BEGIN
    -- Get user's available balance
    SELECT COALESCE(available_neft, 0) INTO available_balance
    FROM user_balances 
    WHERE wallet_address = NEW.wallet_address;
    
    -- Validate sufficient balance for staking
    IF TG_OP = 'INSERT' AND available_balance < NEW.amount THEN
        RAISE EXCEPTION 'Insufficient balance. Available: %, Required: %', 
            available_balance, NEW.amount;
    END IF;
    
    RETURN NEW;
END;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |